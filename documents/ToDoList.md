# ฺฏุฒุงุฑุด ุชุญูู ุนููฺฉุฑุฏ ุตูุญู Add/Edit LegalUnit

**ุชุงุฑุฎ:** 2025-11-21  
**ููุถูุน:** ุจุฑุฑุณ ู ุชุญูู ฺฉูุฏ ุตูุญู ุงุถุงูู/ูุฑุงุด ุจูุฏูุง ูุงููู

---

## ๐ ูุถุนุช ูุนู

**URL ุชุณุช:**
```
https://ingest.tejarat.chat/admin/documents/legalunit/add/?_changelist_filters=manifestation__id__exact%3Da3e0f3bd-275b-4b8b-a89a-6caedf252859
```

**ุฒูุงู ุจุงุฑฺฏุฐุงุฑ ูุนู:** ~15 ุซุงูู  
**ุจูุจูุฏ ุชุงฺฉููู:** ุงุฒ 25 ุซุงูู ุจู 15 ุซุงูู (10 ุซุงูู ุจูุจูุฏ ุจุง ููุชุฑ manifestation)

---

## ๐ ุขูุงุฑ ุฏุชุงุจุณ

- **ุชุนุฏุงุฏ ฺฉู LegalUnit ูุง:** 4,214
- **ุชุนุฏุงุฏ ุฏุฑ manifestation ุชุณุช:** 190 ุจูุฏ
- **Max tree level:** 1 (ุณุงุฎุชุงุฑ ูุณุจุชุงู ุณุงุฏู)

---

## ๐ ูุดฺฉูุงุช ุดูุงุณุง ุดุฏู

### 1๏ธโฃ Parent Field Dropdown (ูุดฺฉู ุงุตู - 80% ฺฉูุฏ)

**ุชูุถุญ ูุดฺฉู:**
- ููุฏ `parent` ุจู ุตูุฑุช ฺฉ ForeignKey dropdown ูพุงุฏูโุณุงุฒ ุดุฏู ุงุณุช
- ุญุช ุจุง ููุชุฑ manifestationุ 190 LegalUnit ุฏุฑ dropdown load ูโุดูุฏ
- Django Admin ููุฑุงู ุจุง MPTT ุจุฑุง ูุฑ item ุฏุฑ dropdownุ tree position ุฑุง ูุญุงุณุจู ูโฺฉูุฏ
- ุงู ุดุงูู ูุญุงุณุจู `lft`, `rght`, `level`, `tree_id` ุจุฑุง ูุฑ ุฑฺฉูุฑุฏ ุงุณุช
- ุจุฑุง 190 itemุ ุงู ูุญุงุณุจุงุช ุจุณุงุฑ ุณูฺฏู ุงุณุช

**ุชุงุซุฑ ุจุฑ ุนููฺฉุฑุฏ:**
- **~12-13 ุซุงูู** ุงุฒ 15 ุซุงูู ฺฉู ุฒูุงู ุจุงุฑฺฏุฐุงุฑ

**ฺฉุฏ ูุฑุจูุทู:**
```python
# ุฏุฑ /srv/ingest/apps/documents/forms.py - ุฎุท 161-163
self.fields['parent'].queryset = LegalUnit.objects.filter(
    manifestation_id=manifestation_id
)  # 190 items โ dropdown โ MPTT calculations โ SLOW!
```

---

### 2๏ธโฃ Inline Forms (10-15% ฺฉูุฏ)

**ุชูุถุญ ูุดฺฉู:**
- ุฏู inline ุชุนุฑู ุดุฏู: `LegalUnitVocabularyTermInline`, `LegalUnitChangeInline`
- ุญุช ุฏุฑ Add form (ฺฉู ุฎุงู ูุณุชูุฏ)ุ Django formset ูุง ุฑุง ูโุณุงุฒุฏ
- ูุฑ inline ฺูุฏ query ุงุถุงู ุจุฑุง load ฺฉุฑุฏู related objects ูโุฒูุฏ

**ุชุงุซุฑ ุจุฑ ุนููฺฉุฑุฏ:**
- **~1-2 ุซุงูู**

**ฺฉุฏ ูุฑุจูุทู:**
```python
# ุฏุฑ /srv/ingest/apps/documents/admin.py - ุฎุท 326
inlines = [LegalUnitVocabularyTermInline, LegalUnitChangeInline]
```

---

### 3๏ธโฃ SimpleHistoryAdmin (5-10% ฺฉูุฏ)

**ุชูุถุญ ูุดฺฉู:**
- ุจุฑุง ููุงุด ุชุงุฑุฎฺู ุชุบุฑุงุชุ query ุงุถุงู ุจู ุฌุฏูู history ูโุฒูุฏ
- ุฏุฑ Add form ุชุงุซุฑ ฺฉูุชุฑ ุฏุงุฑุฏุ ุงูุง ุฏุฑ Edit form ูโุชูุงูุฏ ฺฉูุฏ ุจุงุดุฏ

**ุชุงุซุฑ ุจุฑ ุนููฺฉุฑุฏ:**
- **~0.5-1 ุซุงูู**

---

### 4๏ธโฃ MPTTModelAdmin Overhead

**ุชูุถุญ ูุดฺฉู:**
- ุจุฑุง ููุงุด tree structureุ ูุญุงุณุจุงุช ุงุถุงู ุงูุฌุงู ูโุฏูุฏ
- ุจุง parent dropdown ุชุฑฺฉุจ ูโุดูุฏ ู ฺฉูุฏ ุฑุง ุชุดุฏุฏ ูโฺฉูุฏ

**ุชุงุซุฑ ุจุฑ ุนููฺฉุฑุฏ:**
- **~1 ุซุงูู**

---

## โ ุฑุงูโุญูโูุง ูพุดููุงุฏ

### ๐ฏ ุฑุงูโุญู 1: ุงุณุชูุงุฏู ุงุฒ Autocomplete (ุจูุชุฑู ุฑุงูโุญู)

**ุชุบุฑ ููุฑุฏ ูุงุฒ:**
```python
# ุฏุฑ /srv/ingest/apps/documents/admin.py
class LegalUnitAdmin(SimpleJalaliAdminMixin, MPTTModelAdmin, SimpleHistoryAdmin):
    autocomplete_fields = ['parent']  # ุงุถุงูู ฺฉุฑุฏู ุงู ุฎุท
    # ... ุจูู ุชูุธูุงุช
```

**ูุฒุงุง:**
- โ ููุท 1 query ุจุฑุง load ฺฉุฑุฏู selected item
- โ search ููุท ููุช ฺฉุงุฑุจุฑ ุชุงูพ ูโฺฉูุฏ ุงุฌุฑุง ูโุดูุฏ
- โ MPTT tree ูุญุงุณุจู ููโุดูุฏ
- โ **ุฒูุงู load: ุงุฒ 15s ุจู 1-2s ฺฉุงูุด ูโุงุจุฏ (90% ุจูุจูุฏ)**

**ูพุดโูุงุฒ:**
- `search_fields` ุฏุฑ `LegalUnitAdmin` ุจุงุฏ ุชุนุฑู ุดูุฏ โ (ูุจูุงู ุชุนุฑู ุดุฏู)

**ูุญูู ฺฉุงุฑ:**
- ุจุฌุง dropdown ุจุง 190 itemุ ฺฉ search box ููุงุด ุฏุงุฏู ูโุดูุฏ
- ฺฉุงุฑุจุฑ ุดุฑูุน ุจู ุชุงูพ ูโฺฉูุฏ
- Django ููุท ููุงุฑุฏ ูุทุงุจู ุฑุง ุฌุณุชุฌู ู ููุงุด ูโุฏูุฏ
- ูฺ ูุญุงุณุจู MPTT ุจุฑุง ููู items ุงูุฌุงู ููโุดูุฏ

---

### ๐ฏ ุฑุงูโุญู 2: ุบุฑูุนุงู ฺฉุฑุฏู Inlines ุฏุฑ Add Form

**ุชุบุฑ ููุฑุฏ ูุงุฒ:**
```python
# ุฏุฑ /srv/ingest/apps/documents/admin.py
class LegalUnitAdmin(...):
    def get_inlines(self, request, obj):
        """ููุท ุฏุฑ Edit formุ inlines ุฑุง ููุงุด ุจุฏู"""
        if obj is None:  # Add form
            return []
        return self.inlines
```

**ูุฒุงุง:**
- โ 1-2 ุซุงูู ุณุฑุนโุชุฑ
- โ UX ุจูุชุฑ (ฺฉุงุฑุจุฑ ุฏุฑ Add form ูุงุฒ ุจู inline ูุง ูุฏุงุฑุฏ)
- โ ฺฉุงูุด ูพฺุฏฺฏ ูุฑู

**ููุทู:**
- ุฏุฑ Add formุ ูููุฒ LegalUnit ุณุงุฎุชู ูุดุฏูุ ูพุณ ููโุชูุงู vocabulary terms ุง changes ุงุถุงูู ฺฉุฑุฏ
- ุจูุชุฑ ุงุณุช ฺฉุงุฑุจุฑ ุงุจุชุฏุง LegalUnit ุฑุง ุจุณุงุฒุฏุ ุณูพุณ ุฏุฑ Edit formุ inline ูุง ุฑุง ุงุถุงูู ฺฉูุฏ

---

### ๐ฏ ุฑุงูโุญู 3: ูุญุฏูุฏ ฺฉุฑุฏู SimpleHistory

**ุชุบุฑ ููุฑุฏ ูุงุฒ:**
```python
# ุฏุฑ /srv/ingest/apps/documents/admin.py
class LegalUnitAdmin(...):
    history_list_display = ['history_date', 'history_user']
    # ุง ูุญุฏูุฏ ฺฉุฑุฏู ุชุนุฏุงุฏ history records ููุงุด ุฏุงุฏู ุดุฏู
```

**ูุฒุงุง:**
- โ 0.5-1 ุซุงูู ุณุฑุนโุชุฑ ุฏุฑ Edit form
- โ ฺฉุงูุด ุญุฌู ุฏุงุฏูโูุง load ุดุฏู

---

## ๐ ูพุดโุจู ุจูุจูุฏ ุนููฺฉุฑุฏ

| ุฑุงูโุญู | ุจูุจูุฏ ุฒูุงู | ุฒูุงู ููุง | ุฏุฑุตุฏ ุจูุจูุฏ |
|--------|------------|------------|------------|
| ูุถุนุช ูุนู | - | 15s | - |
| + Autocomplete | -12s | **3s** | 80% โก |
| + Disable Inlines | -1.5s | **1.5s** | 90% โกโก |
| + Optimize History | -0.5s | **1s** | 93% โกโกโก |

---

## ๐ฏ ุชูุตู ููุง

### ุงูููุช 1 (ุญุงุช): Autocomplete
ุงุณุชูุงุฏู ุงุฒ `autocomplete_fields = ['parent']`

**ุฏูู:**
- ุงู ุชููุง ุชุบุฑ ูโุชูุงูุฏ ุฒูุงู ุฑุง ุงุฒ 15s ุจู 3s ฺฉุงูุด ุฏูุฏ
- ุจุดุชุฑู ุชุงุซุฑ ุฑุง ุฏุงุฑุฏ (80% ุจูุจูุฏ)
- ูพุงุฏูโุณุงุฒ ุขุณุงู (ููุท ฺฉ ุฎุท ฺฉุฏ)

### ุงูููุช 2: ุบุฑูุนุงู ฺฉุฑุฏู Inlines
ุบุฑูุนุงู ฺฉุฑุฏู inlines ุฏุฑ Add form

**ุฏูู:**
- ุจูุจูุฏ UX
- 1-2s ุณุฑุนโุชุฑ
- ููุทูโุชุฑ ุงุฒ ูุธุฑ workflow

### ุงูููุช 3: ุจูููโุณุงุฒ SimpleHistory
ูุญุฏูุฏ ฺฉุฑุฏู history records

**ุฏูู:**
- ุชุงุซุฑ ฺฉูุชุฑ ุงูุง ููุฏ ุจุฑุง Edit form
- ุจูุจูุฏ ฺฉู ุนููฺฉุฑุฏ

---

## ๐ ูุชุฌูโฺฏุฑ

ูุดฺฉู ุงุตู ฺฉูุฏ ุตูุญู Add/Edit LegalUnitุ ุงุณุชูุงุฏู ุงุฒ dropdown ุจุฑุง ููุฏ `parent` ุงุณุช ฺฉู ุจุง MPTT ุชุฑฺฉุจ ุดุฏู ู ูุญุงุณุจุงุช ุณูฺฏู ุฑุง ุงุฌุงุฏ ูโฺฉูุฏ.

ุจุง ูพุงุฏูโุณุงุฒ ุฑุงูโุญูโูุง ูพุดููุงุฏ (ุจู ูฺู autocomplete)ุ ูโุชูุงู ุฒูุงู ุจุงุฑฺฏุฐุงุฑ ุฑุง ุงุฒ 15 ุซุงูู ุจู ฺฉูุชุฑ ุงุฒ 2 ุซุงูู ฺฉุงูุด ุฏุงุฏ ฺฉู ุจูุจูุฏ ูุงุจู ุชูุฌู ุฏุฑ ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุงุฌุงุฏ ูโฺฉูุฏ.

---

**ุชููโฺฉููุฏู:** Cascade AI  
**ุชุงุฑุฎ:** 1404/09/01 (2025-11-21)
