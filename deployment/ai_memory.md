# AI Memory - ูพุฑูฺู Ingest

> ุงู ูุงู ุญุงูุธู ูพุฑูฺู ุงุณุช. ูุจู ุงุฒ ูุฑ ุงูุฏุงู ุงู ูุงู ุฑุง ุจุฎูุงูุฏ.
> ุขุฎุฑู ุจูโุฑูุฒุฑุณุงู: 2025-12-14 (ุจูุจูุฏ ูุฑูโูุง Admin)

---

## ๐ฏ ูุฏู ูพุฑูฺู

ุณุณุชู **Ingest** ุจุฑุง ูุฏุฑุช ุงุณูุงุฏ ุญููู ุทุฑุงุญ ุดุฏู ุงุณุช:
- ุฐุฎุฑู ู ูุฏุฑุช ูุชูู ูุงููู ุจุง ุณุงุฎุชุงุฑ ุณูุณููโูุฑุงุชุจ (FRBR)
- ฺุงูฺฉโฺฉุฑุฏู ูุชูู ุจุฑุง ูพุฑุฏุงุฒุด AI
- ุชููุฏ embedding ุจุฑุง ุฌุณุชุฌู ูุนูุง
- ููฺฏุงูโุณุงุฒ ุจุง ุณุณุชู ูุฑฺฉุฒ (Hakim)

---

## ๐ฆ ุณุงุฎุชุงุฑ ูุฏูโูุง

### FRBR Hierarchy
```
InstrumentWork (ุงุซุฑ) โ InstrumentExpression (ุจุงู) โ InstrumentManifestation (ุชุฌู)
                                                              โ
                                                         LegalUnit (ุจูุฏ ุญููู)
                                                              โ
                                                           Chunk (ูุทุนู ูุชู)
                                                              โ
                                                         Embedding (ุจุฑุฏุงุฑ)
```

### ูุฏูโูุง ฺฉูุฏ
- **LegalUnit**: ุจูุฏูุง ุญููู ุจุง ุณุงุฎุชุงุฑ ุฏุฑุฎุช (MPTT)
- **Chunk**: ูุทุนุงุช ูุชู ุจุฑุง embedding
- **QAEntry**: ูพุฑุณุด ู ูพุงุณุฎ
- **Embedding**: ุจุฑุฏุงุฑูุง embedding ุจุง ูพุดุชุจุงู ฺูุฏ ูุฏู

---

## โ๏ธ ุชูุธูุงุช ููู

### Embedding
| ูพุงุฑุงูุชุฑ | ููุฏุงุฑ |
|---------|-------|
| ูุฏู | `intfloat/multilingual-e5-large` |
| ุงุจุนุงุฏ | `1024` |
| Cache | `/app/models` |

### Chunking
| ูพุงุฑุงูุชุฑ | ููุฏุงุฑ |
|---------|-------|
| ุงูุฏุงุฒู ฺุงูฺฉ | `350` ุชูฺฉู |
| ูููพูุดุงู | `80` ุชูฺฉู |
| ุงุนุฏุงุฏ ูุงุฑุณ | ุชุจุฏู ุจู ุงูฺฏูุณ |

### Environment Variables
```bash
EMBEDDING_E5_MODEL_NAME=intfloat/multilingual-e5-large
EMBEDDING_DIMENSION=1024
EMBEDDING_PROVIDER=e5
CHUNK_SIZE=350
CHUNK_OVERLAP=80
```

---

## ๐ ููฺฏุงูโุณุงุฒ ุจุง ุณุณุชู ูุฑฺฉุฒ (Core)

### ุชูุธูุงุช ุฏุฑ Admin
ุชูุธูุงุช sync ุฏุฑ `/admin/embeddings/coreconfig/` ูุงุจู ูุดุงูุฏู ู ุชุบุฑ ุงุณุช.

### Celery Beat Tasks (ุฒูุงูโุจูุฏ ุฎูุฏฺฉุงุฑ)
| Task | ุฒูุงูโุจูุฏ | ุชูุถุญ |
|------|-----------|-------|
| `auto_sync_new_embeddings` | ูุฑ 5 ุฏููู | embeddings ุฌุฏุฏ ุฑุง ุจู Core ุงุฑุณุงู ูโฺฉูุฏ |
| `sync_changed_metadata` | ูุฑ 15 ุฏููู | ุชุบุฑุงุช metadata (ุชฺฏุ ุชุงุฑุฎุ ...) ุฑุง sync ูโฺฉูุฏ |
| `cleanup_orphaned_nodes` | ุฑูุฒุงูู 2:30 | ููุฏูุง ุญุฐูโุดุฏู ุฑุง ุงุฒ Core ูพุงฺฉ ูโฺฉูุฏ |
| `check_missing_embeddings` | ูุฑ ุณุงุนุช | ฺฺฉ ูโฺฉูุฏ ฺุงูฺฉโูุง ุจุฏูู embedding ููุงูุฏู ุจุงุดูุฏ |

### ุฒูุงู ุฑุณุฏู ุชุบุฑุงุช ุจู Core
| ุณูุงุฑู | ุฒูุงู |
|--------|------|
| ุงุฌุงุฏ/ูุฑุงุด ูุชู ุจูุฏ | ุญุฏุงฺฉุซุฑ **5 ุฏููู** (ุจุนุฏ ุงุฒ ฺุงูฺฉ ู embedding) |
| ุงุถุงูู ฺฉุฑุฏู ุชฺฏ | ุญุฏุงฺฉุซุฑ **15 ุฏููู** |
| ุชุบุฑ ุชุงุฑุฎ ุงุนุชุจุงุฑ | ุญุฏุงฺฉุซุฑ **15 ุฏููู** |

### ุดุฑุงุท ูุนุงู ุจูุฏู Sync
- `CoreConfig.is_active = True`
- `CoreConfig.auto_sync_enabled = True`
- `core_api_url` ุฏุฑุณุช ุชูุธู ุดุฏู ุจุงุดุฏ
- Celery Beat ุฏุฑ ุญุงู ุงุฌุฑุง ุจุงุดุฏ

### Signals
- ุณฺฏูุงูโูุง ุฏุฑ `signals_unified.py` ูุชูุฑฺฉุฒ ุดุฏูโุงูุฏ
- ุจุนุฏ ุงุฒ ุฐุฎุฑู LegalUnit/QAEntryุ ฺุงูฺฉ ู embedding ุชููุฏ ูโุดูุฏ
- ุชุบุฑ metadata ุจุงุนุซ `metadata_hash=''` ูโุดูุฏ ฺฉู ุฏุฑ sync ุจุนุฏ ุงุฑุณุงู ูโุดูุฏ

---

## ๐๏ธ ุชุบุฑุงุช ุงูุฌุงูโุดุฏู (ุชุงุฑุฎฺู)

### 2025-12-14: ูพุงฺฉุณุงุฒ ฺฉุฏ
- โ ูุฏู embedding ุจู `multilingual-e5-large` ุงุณุชุงูุฏุงุฑุฏ ุดุฏ
- โ ูุงูโูุง deprecated ุญุฐู ุดุฏูุฏ:
  - `admin_fast.py`, `admin_optimized.py`
  - `fields.py`, `widgets.py` (ุฏุฑ accounts)
  - `services.py`, `signals.py`, `signals_complete.py`
- โ ฺฉุฏ ฺฉุงููุชโุดุฏู `@extend_schema` ุญุฐู ุดุฏ
- โ import ูุง ุจูุงุงุณุชูุงุฏู ุญุฐู ุดุฏูุฏ
- โ Provider fallback ุงุฒ `hakim` ุจู `e5` ุงุตูุงุญ ุดุฏ
- โ ุงุณฺฉุฑูพุชโูุง ุฎุงู ุญุฐู ุดุฏูุฏ

### 2025-12-04: ุจูุจูุฏ ูุฑูโูุง Admin
#### ูุฑู ฺฉูพุงุฑฺู ุณูุฏ ุญููู (`admin_document.py`)
- โ ุงุฌุงุฏ ูุฑู ฺฉูพุงุฑฺู ุจุฑุง Work + Expression + Manifestation
- โ ุชูุงู ููุฏูุง ุชุงุฑุฎ ุจู ุดูุณ (JalaliDateField) ุชุจุฏู ุดุฏูุฏ
- โ ุจุฎุด "ูุณุฎู ู ุฒุจุงู" ุงุฒ ุญุงูุช collapse ุฎุงุฑุฌ ุดุฏ
- โ ูุงู "ุฑูุฒูุงูู ุฑุณู" ุจู "ูุญู ุงูุชุดุงุฑ" ุชุบุฑ ฺฉุฑุฏ
- โ ููุฏูุง ุชุงุฑุฎ ุฏุฑ ฺฉ ุจุฎุด ุฌุฏุงฺฏุงูู ฺฏุฑููโุจูุฏ ุดุฏูุฏ
- โ ุฎูุงุตู ููุถูุน ุจุฒุฑฺฏุชุฑ ุดุฏ (8 ุณุทุฑุ 70% ุนุฑุถ)
- โ ูุฑุชุจโุณุงุฒ ูพุดโูุฑุถ ุจุฑ ุงุณุงุณ ุนููุงู ุณูุฏ
- โ ุงฺฏุฑ "ุงุฌุฑุง ุงุฒ ุชุงุฑุฎ" ุฎุงู ุจุงุดุฏุ "ุชุงุฑุฎ ุงูุชุดุงุฑ" ฺฉูพ ูโุดูุฏ

#### ูุฑู ุจูุฏูุง ุญููู (`admin_lunit.py` ู `forms.py`)
- โ ููุน ูุงุญุฏ "ููู ูุชู" (FULL_TEXT) ุจู enum ุงุถุงูู ุดุฏ
- โ ููุฏ "ุชุฑุชุจ" ุงุฒ ุนุฏุฏ ุจู ูุชู ุชุบุฑ ฺฉุฑุฏ (migration 0013)
- โ "ุชุงุฑุฎ ุชุตูุจ/ุงุฌุฑุง" ุจู "ุชุงุฑุฎ ุงุจูุงุบ/ุงุฌุฑุง" ุชุบุฑ ฺฉุฑุฏ
- โ ุงฺฏุฑ ุชุงุฑุฎ ุงุจูุงุบ ุฎุงู ุจุงุดุฏุ ุงุฒ `in_force_from` ุณูุฏ ุงุตู ุงุณุชูุงุฏู ูโุดูุฏ
- โ ุชุงุฑุฎโูุง ุฏุฑ ฺฉ ุณุทุฑ ุจุง CSS flex
- โ ูุญุชูุง ุงุฒ 12 ุจู 20 ุณุทุฑ ุงูุฒุงุด ุงูุช
- โ placeholder ูุง ูพุดโูุฑุถ ุญุฐู ุดุฏูุฏ

#### ุตูุญู ูุณุช LUnit
- โ ุณุชูู "ููุน ุณูุฏ" ุงุถุงูู ุดุฏ
- โ ุตูุญู ุงูุชุฎุงุจ ุณูุฏ: ุณุชููโูุง ุชุงุฑุฎ ุชุตูุจุ ููุน ุณูุฏุ ุชุนุฏุงุฏ ุจูุฏูุง ุงุถุงูู ุดุฏ
- โ ูุฑุชุจโุณุงุฒ ุจุฑ ุงุณุงุณ ุนููุงู ุณูุฏ

#### ุชุฑุชุจ ููู Admin
- โ ุจูุฏูุง ุงุณูุงุฏ ุญููู (LUnit) - ุงูู
- โ ูพุฑุณุด ู ูพุงุณุฎ - ุฏูู
- โ ุงุณูุงุฏ ุญููู (ูุฑู ฺฉูพุงุฑฺู) - ูุจู ุงุฒ Work/Expression/Manifestation

#### Migration ุฏุงุฏูโูุง
- โ 3375 ุฑฺฉูุฑุฏ LegalUnit: `valid_from` ุงุฒ `publication_date` ุจู `in_force_from` ุชุบุฑ ฺฉุฑุฏ
- โ 1 ุฑฺฉูุฑุฏ InstrumentManifestation: `in_force_from` ุจุง `publication_date` ูพุฑ ุดุฏ

### ูฺฉุงุช ูู
- ุฏุงูููุฏ ูุฏู ุฏุฑ Dockerfile ุบุฑูุนุงู ุงุณุช (ุญุฌู ุจุงูุง)
- ูุฏู ุฏุฑ ุงููู ุงุณุชูุงุฏู ุฏุงูููุฏ ูโุดูุฏ ุง ุฏุณุช ุจู `/app/models` ฺฉูพ ุดูุฏ

---

## ๐ ูุงูโูุง ฺฉูุฏ

| ูุงู | ุชูุถุญ |
|------|-------|
| `/srv/.env` | ุชูุธูุงุช ูุญุท ุงุตู |
| `/srv/ingest/settings/base.py` | ุชูุธูุงุช Django |
| `/srv/ingest/apps/documents/models.py` | ูุฏูโูุง ุงุตู |
| `/srv/ingest/apps/documents/admin.py` | ูพูู ุงุฏูู ุงุตู |
| `/srv/ingest/apps/documents/admin_document.py` | ูุฑู ฺฉูพุงุฑฺู ุณูุฏ ุญููู |
| `/srv/ingest/apps/documents/admin_lunit.py` | ุงุฏูู ุจูุฏูุง ุญููู |
| `/srv/ingest/apps/documents/forms.py` | ูุฑูโูุง ุงุฏูู |
| `/srv/ingest/apps/documents/enums.py` | ุงููุงุน ุฏุงุฏู (UnitType, DocumentType, ...) |
| `/srv/ingest/apps/embeddings/tasks.py` | ุชุณฺฉโูุง Celery |
| `/srv/ingest/apps/documents/signals_unified.py` | ุณฺฏูุงูโูุง ฺฉูพุงุฑฺู |
| `/srv/ingest/core/text_processing.py` | ูพุฑุฏุงุฒุด ูุชู |
| `/srv/ingest/static/admin/css/legalunit-changes.css` | ุงุณุชุงูโูุง ุณูุงุฑุด ุงุฏูู |
| `/srv/ingest/templates/admin/documents/legalunit_manifestation_list.html` | ุตูุญู ุงูุชุฎุงุจ ุณูุฏ ุจุฑุง LUnit |

---

## โ๏ธ ูฺฉุงุช ููู ุจุฑุง AI

1. **ูุฏู embedding**: ููุท `intfloat/multilingual-e5-large` ุจุง dimension `1024`
2. **ูุงูโูุง deprecated**: ุญุฐู ุดุฏูโุงูุฏุ ุงุฒ ุขููุง ุงุณุชูุงุฏู ูฺฉูุฏ
3. **ุณฺฏูุงูโูุง**: ููุท ุงุฒ `signals_unified.py` ุงุณุชูุงุฏู ฺฉูุฏ
4. **Admin**: ฺฉูุงุณโูุง utility ุฏุฑ `ingest.core.admin_utils` ูุณุชูุฏ
5. **Commit**: ุจุนุฏ ุงุฒ ูุฑ ุชุบุฑ ููููุ ุฎูุฏฺฉุงุฑ commit ฺฉูุฏ
6. **ุชุงุฑุฎ ุดูุณ**: ุงุฒ `JalaliDateField` ู `JalaliDateWidget` ุงุณุชูุงุฏู ฺฉูุฏ (ุฏุฑ `ingest.core.forms`)
7. **ูุฑู ฺฉูพุงุฑฺู**: ุจุฑุง ุณูุฏ ุญููู ุงุฒ `admin_document.py` ุงุณุชูุงุฏู ฺฉูุฏ
8. **ููุงุฏุฑ ูพุดโูุฑุถ ุชุงุฑุฎ**:
   - ุฏุฑ Document: ุงฺฏุฑ `in_force_from` ุฎุงู ุจุงุดุฏ โ `publication_date`
   - ุฏุฑ LUnit: ุงฺฏุฑ `valid_from` ุฎุงู ุจุงุดุฏ โ `manifestation.in_force_from`

---

## ๐ ูุดฺฉูุงุช ุดูุงุฎุชูโุดุฏู

| ูุดฺฉู | ูุถุนุช |
|------|-------|
| ุญุฐู ูุงูุฏ ุงุฒ LegalUnit ุฏุฑ ุงุฏูู | ุฏุฑ ุญุงู ุจุฑุฑุณ |

---

## ๐ ุงุฏุฏุงุดุชโูุง ฺฉุงุฑุจุฑ

- ฺฉุงุฑุจุฑ ูุงุฑุณโุฒุจุงู ุงุณุช
- ุชุฑุฌุญ ูโุฏูุฏ ุชูุถุญุงุช ุจู ูุงุฑุณ ุจุงุดุฏ
- ูโุฎูุงูุฏ ฺฉุฏ ุชูุฒ ู ุจุฏูู bloat ุจุงุดุฏ
