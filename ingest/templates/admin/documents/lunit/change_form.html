{% extends "admin/change_form.html" %}

{% block breadcrumbs %}
{# حذف breadcrumbs - فقط h1 با path کامل نمایش داده شود #}
{% endblock %}

{% block content_title %}
{# حذف content title اضافی #}
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script>
// حذف یک برچسب با کلیک روی دکمه ضربدر
function deleteSingleTag(tagId, row) {
    if (!confirm('آیا از حذف این برچسب مطمئن هستید؟')) {
        return;
    }
    
    const objectId = window.location.pathname.split('/').filter(x => x).slice(-2, -1)[0];
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/admin/documents/lunit/${objectId}/delete-tags/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({tag_ids: [tagId]})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // رفرش صفحه برای بروزرسانی فرم
            window.location.reload();
        } else {
            alert('خطا: ' + (data.error || 'مشکلی پیش آمد'));
        }
    })
    .catch(error => {
        alert('خطا در ارتباط با سرور: ' + error);
    });
}

// اضافه کردن دکمه ضربدر به هر ردیف برچسب
document.addEventListener('DOMContentLoaded', function() {
    // پیدا کردن همه inline groups
    const allInlineGroups = document.querySelectorAll('.inline-group');
    let inlineGroup = null;
    
    allInlineGroups.forEach(function(g) {
        // چک کردن عنوان
        const header = g.querySelector('h2');
        if (header && header.textContent.includes('برچسب')) {
            inlineGroup = g;
        }
    });
    
    if (!inlineGroup) {
        console.log('Tag inline group not found. Available groups:', 
            Array.from(allInlineGroups).map(g => g.id).join(', '));
        return;
    }
    
    console.log('Found inline group:', inlineGroup.id);
    
    // پیدا کردن همه ردیف‌های برچسب در tbody
    const tbody = inlineGroup.querySelector('tbody');
    if (!tbody) {
        console.log('No tbody found');
        return;
    }
    
    const rows = tbody.querySelectorAll('tr');
    console.log('Found rows:', rows.length);
    
    rows.forEach(function(row, index) {
        // رد کردن ردیف‌های خالی یا template
        if (row.classList.contains('empty-form') || row.id.includes('__prefix__') || row.classList.contains('add-row')) return;
        
        // پیدا کردن ID برچسب
        const idInput = row.querySelector('input[name$="-id"]');
        if (!idInput || !idInput.value) {
            return;
        }
        
        const tagId = idInput.value;
        
        // پیدا کردن همه td ها
        const allTds = row.querySelectorAll('td');
        
        // پیدا کردن td که checkbox DELETE دارد (معمولاً td.delete)
        let deleteTd = null;
        allTds.forEach(function(td) {
            if (td.classList.contains('delete') || td.querySelector('input[name$="-DELETE"]')) {
                deleteTd = td;
            }
        });
        
        if (!deleteTd) {
            return;
        }
        
        // مخفی کردن متن توضیحی در td.original (نگه داشتن hidden inputs)
        const originalTd = row.querySelector('td.original');
        if (originalTd) {
            // فقط <p> را مخفی کن، hidden input ها را نگه دار
            const pTag = originalTd.querySelector('p');
            if (pTag) {
                pTag.style.display = 'none';
            }
        }
        
        // ساخت دکمه ضربدر
        const deleteBtn = document.createElement('a');
        deleteBtn.href = '#';
        deleteBtn.className = 'delete-tag-btn';
        deleteBtn.title = 'حذف برچسب';
        deleteBtn.style.cssText = 'display: block; text-align: center; color: #ba2121; font-size: 24px; font-weight: bold; text-decoration: none; cursor: pointer;';
        deleteBtn.innerHTML = '✕';
        deleteBtn.onclick = function(e) {
            e.preventDefault();
            deleteSingleTag(tagId, row);
        };
        
        // خالی کردن td و اضافه کردن دکمه
        deleteTd.innerHTML = '';
        deleteTd.appendChild(deleteBtn);
    });
});
</script>
{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    /* پنهان کردن دکمه‌های اضافی کنار فیلد parent */
    .field-parent .related-widget-wrapper-link,
    .field-parent a.related-widget-wrapper-link,
    .field-parent .related-lookup,
    .field-parent .changelink,
    .field-parent .addlink,
    .field-parent .viewlink {
        display: none !important;
        visibility: hidden !important;
    }
    
    /* پنهان کردن select اصلی parent و نمایش فقط autocomplete */
    .field-parent select {
        display: none !important;
    }
    
    /* تنظیم عرض فیلد parent autocomplete */
    .field-parent input[type="text"],
    .field-parent .parent-autocomplete-search {
        width: 500px !important;
        display: inline-block !important;
    }
    
    /* autocomplete dropdown */
    .parent-autocomplete-results,
    .ui-autocomplete,
    .select2-dropdown,
    .autocomplete-suggestions {
        z-index: 99999 !important;
        position: absolute !important;
        background: white !important;
        border: 1px solid #ccc !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important;
        max-height: 150px !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
    }
    
    /* Table و container ها */
    table,
    .module,
    #content-main,
    #content {
        overflow: visible !important;
    }
    
    /* فقط textarea overflow داشته باشد */
    textarea {
        overflow: auto !important;
    }
    
    /* فاصله برای parent autocomplete */
    .form-row:has(.field-parent) {
        position: relative;
        margin-bottom: 180px !important;
    }
    
    /* تنظیم عرض فیلدها برای جا شدن در یک خط */
    .field-order_index input {
        width: 80px !important;
        display: inline-block !important;
    }
    
    .field-unit_type select {
        width: 200px !important;
        display: inline-block !important;
    }
    
    .field-number input {
        width: 100px !important;
        display: inline-block !important;
    }
    
    /* تنظیم عرض فیلدهای تاریخ */
    .field-valid_from input,
    .field-valid_to input {
        width: 150px !important;
        display: inline-block !important;
    }
    
    /* حذف bold از label های فیلدها */
    .form-row label {
        font-weight: normal !important;
    }
    
    /* حذف bold از label های خاص */
    .field-order_index label,
    .field-unit_type label,
    .field-number label,
    .field-content label {
        font-weight: normal !important;
    }
    
    /* حذف هر خط اضافی بالای فرم */
    .breadcrumbs,
    #content > h1:first-child,
    #content-main > div:first-child:not(.module),
    .submit-row + p,
    div[style*="background"] {
        display: none !important;
    }
</style>

<script>
// Shortkey F2 برای دکمه اضافه کردن
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('keydown', function(e) {
        // F2 برای اضافه کردن
        if (e.key === 'F2') {
            e.preventDefault();
            // پیدا کردن دکمه اضافه کردن
            const addButton = document.querySelector('.object-tools .addlink');
            if (addButton) {
                window.location.href = addButton.href;
            }
        }
    });
});
</script>
{% endblock %}
