{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content_title %}{% endblock %}

{% block content %}
<div class="module" style="direction: rtl; text-align: right;">
    
    <!-- Rebuild Button -->
    <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3 style="margin-top: 0; color: #856404;">ğŸ”„ Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Embeddings</h3>
        <p style="margin: 10px 0; color: #856404;">
            <strong>ØªÙˆØ¬Ù‡:</strong> Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª ØªÙ…Ø§Ù… embeddings Ù…ÙˆØ¬ÙˆØ¯ Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯Ù‡ Ùˆ Ø¨Ø§ Ù…Ø¯Ù„ ÙØ¹Ù„ÛŒ Ø¯Ø± .env Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
            Ø§ÛŒÙ† Ú©Ø§Ø± Ø²Ù…Ø§Ù†ÛŒ Ù…ÙÛŒØ¯ Ø§Ø³Øª Ú©Ù‡:
        </p>
        <ul style="color: #856404; margin: 10px 0 15px 20px;">
            <li>Ù…Ø¯Ù„ embedding Ø±Ø§ Ø¯Ø± ÙØ§ÛŒÙ„ .env ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯</li>
            <li>Ø´Ú© Ø¯Ø§Ø±ÛŒØ¯ Ú©Ù‡ embeddings ÙØ¹Ù„ÛŒ ØµØ­ÛŒØ­ Ù‡Ø³ØªÙ†Ø¯</li>
            <li>Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù‡Ù…Ù‡ Ø±Ø§ Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø³Ø§Ø²ÛŒØ¯</li>
        </ul>
        <form method="post" onsubmit="return confirm('âš ï¸ Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\n\nØªÙ…Ø§Ù… {{ chunks_with_embeddings|default:0 }} embedding Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ø±Ø¯Ø§Ø±Ø³Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯ Ø´Ø±ÙˆØ¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.\n\nØ§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø³Ø§Ø¹Øª Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯.');">
            {% csrf_token %}
            <button type="submit" name="rebuild_all_embeddings" style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;">
                ğŸ”„ Ø­Ø°Ù Ùˆ Ø³Ø§Ø®Øª Ù…Ø¬Ø¯Ø¯ Ù‡Ù…Ù‡ Embeddings
            </button>
        </form>
    </div>

    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2>ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
            <div style="background: white; padding: 15px; border-radius: 5px; border-right: 4px solid #4CAF50;">
                <div style="color: #666; font-size: 12px;">Ø¨Ù†Ø¯Ù‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ (Legal Units)</div>
                <div style="font-size: 24px; font-weight: bold; color: #333;">{{ total_legal_units|default:0 }}</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 5px; border-right: 4px solid #FF9800;">
                <div style="color: #666; font-size: 12px;">Ù¾Ø±Ø³Ø´ Ùˆ Ù¾Ø§Ø³Ø® (Q&A)</div>
                <div style="font-size: 24px; font-weight: bold; color: #333;">{{ total_qa|default:0 }}</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 5px; border-right: 4px solid #9C27B0;">
                <div style="color: #666; font-size: 12px;">Ù…ØªÙˆÙ† (TextEntry)</div>
                <div style="font-size: 24px; font-weight: bold; color: #333;">{{ total_text|default:0 }}</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 5px; border-right: 4px solid #2196F3;">
                <div style="color: #666; font-size: 12px;">Ù…Ø¬Ù…ÙˆØ¹ Ú†Ø§Ù†Ú©â€ŒÙ‡Ø§</div>
                <div style="font-size: 24px; font-weight: bold; color: #333;">{{ total_chunks|default:0 }}</div>
            </div>
        </div>
    </div>

    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2>ğŸ”¢ Ø¢Ù…Ø§Ø± Chunking Ùˆ Embedding</h2>
        <table style="width: 100%; background: white; border-radius: 5px; margin-top: 15px;">
            <tr style="background: #f5f5f5;">
                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Ù…Ù†Ø¨Ø¹</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">ØªØ¹Ø¯Ø§Ø¯ Ù…Ù†Ø¨Ø¹</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Ú†Ø§Ù†Ú©â€ŒÙ‡Ø§</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Ø¯Ø§Ø±Ø§ÛŒ Embedding</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Ø¨Ø¯ÙˆÙ† Embedding</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">Ø¯Ø±ØµØ¯</th>
            </tr>
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">ğŸ›ï¸ Ø¨Ù†Ø¯Ù‡Ø§ÛŒ Ù‚Ø§Ù†ÙˆÙ†ÛŒ</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ total_legal_units|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ lu_chunks|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: #4CAF50; font-weight: bold;">{{ lu_chunks_with_embeddings|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: #f44336; font-weight: bold;">{{ lu_chunks_missing|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
                    <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                        <div style="background: #4CAF50; height: 20px; width: {{ lu_percentage|default:0 }}%;"></div>
                    </div>
                    {{ lu_percentage|default:0 }}%
                </td>
            </tr>
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">â“ Ù¾Ø±Ø³Ø´ Ùˆ Ù¾Ø§Ø³Ø®</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ total_qa|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ qa_chunks|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: #4CAF50; font-weight: bold;">{{ qa_chunks_with_embeddings|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: #f44336; font-weight: bold;">{{ qa_chunks_missing|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
                    <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                        <div style="background: #FF9800; height: 20px; width: {{ qa_percentage|default:0 }}%;"></div>
                    </div>
                    {{ qa_percentage|default:0 }}%
                </td>
            </tr>
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">ğŸ“ Ù…ØªÙˆÙ†</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ total_text|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ text_chunks|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: #4CAF50; font-weight: bold;">{{ text_chunks_with_embeddings|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: #f44336; font-weight: bold;">{{ text_chunks_missing|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
                    <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                        <div style="background: #9C27B0; height: 20px; width: {{ text_percentage|default:0 }}%;"></div>
                    </div>
                    {{ text_percentage|default:0 }}%
                </td>
            </tr>
            <tr style="background: #f5f5f5; font-weight: bold;">
                <td style="padding: 12px; border-bottom: 1px solid #eee;">ğŸ“Š Ù…Ø¬Ù…ÙˆØ¹</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">-</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ total_chunks|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: #4CAF50;">{{ chunks_with_embeddings|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: #f44336;">{{ chunks_missing|default:0 }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">
                    <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                        <div style="background: #2196F3; height: 20px; width: {{ chunks_percentage|default:0 }}%;"></div>
                    </div>
                    {{ chunks_percentage|default:0 }}%
                </td>
            </tr>
        </table>
    </div>

    <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2>ğŸ”„ Ø¢Ù…Ø§Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Core</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
            <div style="background: white; padding: 15px; border-radius: 5px; border-right: 4px solid #4CAF50;">
                <div style="color: #666; font-size: 12px;">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡</div>
                <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">{{ synced_embeddings|default:0 }}</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 5px; border-right: 4px solid #FF9800;">
                <div style="color: #666; font-size: 12px;">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</div>
                <div style="font-size: 24px; font-weight: bold; color: #FF9800;">{{ pending_sync|default:0 }}</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 5px; border-right: 4px solid #2196F3;">
                <div style="color: #666; font-size: 12px;">Ø¯Ø±ØµØ¯ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</div>
                <div style="font-size: 24px; font-weight: bold; color: #2196F3;">{{ sync_percentage|default:0 }}%</div>
            </div>
        </div>
    </div>

    <div style="background: #fff3e0; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ¹Ù„ÛŒ</h2>
        <table style="width: 100%; background: white; border-radius: 5px; margin-top: 15px;">
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: bold;">Ù…Ø¯Ù„ Embedding</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ current_model }}</td>
            </tr>
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: bold;">Dimension</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ current_dimension }}</td>
            </tr>
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: bold;">Chunk Size</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ chunk_size }} tokens</td>
            </tr>
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee; font-weight: bold;">Chunk Overlap</td>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ chunk_overlap }} tokens</td>
            </tr>
        </table>
    </div>

    <div style="background: #f3e5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2>ğŸ“ˆ ÙØ¹Ø§Ù„ÛŒØª Ø§Ø®ÛŒØ± (24 Ø³Ø§Ø¹Øª Ú¯Ø°Ø´ØªÙ‡)</h2>
        <div style="background: white; padding: 15px; border-radius: 5px; margin-top: 15px;">
            <p><strong>Ú†Ø§Ù†Ú©â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯:</strong> {{ recent_chunks|default:0 }}</p>
            <p><strong>Embedding Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯:</strong> {{ recent_embeddings|default:0 }}</p>
        </div>
    </div>

    {% if embedding_by_model %}
    <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2>ğŸ¤– Ø¢Ù…Ø§Ø± Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ù…Ø¯Ù„</h2>
        <table style="width: 100%; background: white; border-radius: 5px; margin-top: 15px;">
            <tr style="background: #f5f5f5;">
                <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Ù…Ø¯Ù„</th>
                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">ØªØ¹Ø¯Ø§Ø¯</th>
            </tr>
            {% for model in embedding_by_model %}
            <tr>
                <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ model.model_id }}</td>
                <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ model.count }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    <div style="background: #fce4ec; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h2>ğŸ”„ ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±</h2>
        <div style="background: white; padding: 15px; border-radius: 5px; margin-top: 15px;">
            <p>âœ… <strong>Chunking Ø®ÙˆØ¯Ú©Ø§Ø±:</strong> Ù‡Ù†Ú¯Ø§Ù… Ø§ÛŒØ¬Ø§Ø¯ ÛŒØ§ ÙˆÛŒØ±Ø§ÛŒØ´ Legal UnitØŒ QA Entry ÛŒØ§ TextEntry</p>
            <p>âœ… <strong>Embedding Ø®ÙˆØ¯Ú©Ø§Ø±:</strong> Ù‡Ù†Ú¯Ø§Ù… Ø§ÛŒØ¬Ø§Ø¯ Chunk Ø¬Ø¯ÛŒØ¯</p>
            <p>âœ… <strong>Sync Ø®ÙˆØ¯Ú©Ø§Ø±:</strong> Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ø³ÛŒØ³ØªÙ… Ù…Ø±Ú©Ø²ÛŒ (Core) Ù¾Ø³ Ø§Ø² Ø§ÛŒØ¬Ø§Ø¯ Embedding</p>
            <p>âœ… <strong>Ø¨Ø±Ø±Ø³ÛŒ Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ:</strong> Ù‡Ø± Ø³Ø§Ø¹Øª Ú†Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ú©Ù‡ Ø¢ÛŒØ§ Chunk Ø¨Ø¯ÙˆÙ† Embedding ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯</p>
            <p>âœ… <strong>Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±:</strong> Ø±ÙˆØ²Ø§Ù†Ù‡ Embedding Ù‡Ø§ÛŒ orphan Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</p>
            <p>âœ… <strong>Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø±:</strong> Ø¨Ø§ Ø­Ø°Ù Legal UnitØŒ QA Entry ÛŒØ§ TextEntryØŒ Chunk Ù‡Ø§ Ùˆ Embedding Ù‡Ø§ÛŒ Ù…Ø±ØªØ¨Ø· Ø­Ø°Ù Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</p>
        </div>
    </div>

    <div style="margin-top: 30px; padding: 15px; background: #fff9c4; border-radius: 5px; border-right: 4px solid #FFC107;">
        <h3>ğŸ’¡ Ù†Ú©Ø§Øª Ù…Ù‡Ù…</h3>
        <ul>
            <li>ØªÙ…Ø§Ù… ÙØ±Ø¢ÛŒÙ†Ø¯Ù‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</li>
            <li>Embedding Ù‡Ø§ Ø¯Ø± background ØªÙˆØ³Ø· Celery worker Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</li>
            <li>Ø¯Ø± ØµÙˆØ±Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Chunk Ø¨Ø¯ÙˆÙ† EmbeddingØŒ ØªØ§ ÛŒÚ© Ø³Ø§Ø¹Øª ØµØ¨Ø± Ú©Ù†ÛŒØ¯ (task Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯)</li>
            <li>Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ worker: <code>docker logs deployment-worker-1 -f</code></li>
        </ul>
    </div>
</div>
{% endblock %}
