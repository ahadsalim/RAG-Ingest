{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Ø®Ø§Ù†Ù‡</a>
    &rsaquo; <a href="/admin/embeddings/manage/">Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯â€ŒÙ‡Ø§</a>
    &rsaquo; Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
</div>
{% endblock %}

{% block content %}
<div class="module aligned" style="direction: rtl; text-align: right;">
    <!-- ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ… -->
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h2>ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
            <div class="stat-box" style="background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center;">
                <strong>ØµÙ Ø§Ù†ØªØ¸Ø§Ø±</strong><br>
                <span style="font-size: 24px; color: #007cba;">{{ queue_length }}</span><br>
                <small>task Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</small>
            </div>
            <div class="stat-box" style="background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center;">
                <strong>Task Ù‡Ø§ÛŒ Redis</strong><br>
                <span style="font-size: 24px; color: #28a745;">{{ recent_tasks_count|default:0 }}</span><br>
                <small>Ú©Ù„ task Ù‡Ø§</small>
            </div>
            <div class="stat-box" style="background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center;">
                <strong>Task Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„</strong><br>
                <span style="font-size: 24px; color: #17a2b8;">{{ active_tasks_count|default:0 }}</span><br>
                <small>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§</small>
            </div>
            <div class="stat-box" style="background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center;">
                <strong>Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯ Ø¯Ø± Redis</strong><br>
                <span style="font-size: 24px; color: #ffc107;">{{ embedding_tasks_count|default:0 }}</span><br>
                <small>task Ù‡Ø§ÛŒ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯</small>
            </div>
        </div>
        
        <!-- Ø¯Ú©Ù…Ù‡ refresh -->
        <div style="margin-top: 15px; text-align: center;">
            <a href="{{ log_refresh_url }}" class="btn btn-primary" style="background-color: #007cba; color: white; text-decoration: none; padding: 8px 16px; border-radius: 4px;">
                ğŸ”„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§
            </a>
        </div>
    </div>

    <!-- Ø¢Ù…Ø§Ø± Ø²Ù…Ø§Ù†ÛŒ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¯Ù„ -->
    {% if embedding_models_stats %}
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h2 style="color: white;">ğŸ“ˆ Ø¢Ù…Ø§Ø± Ø²Ù…Ø§Ù†ÛŒ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¯Ù„</h2>
        
        <!-- Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 15px 0;">
            <div class="stat-box" style="background: #e7f3ff; padding: 10px; border-radius: 5px; text-align: center;">
                <strong>Ú©Ù„ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯â€ŒÙ‡Ø§</strong><br>
                <span style="font-size: 20px; color: #0066cc;">{{ embedding_stats.total_embeddings }}</span>
            </div>
            <div class="stat-box" style="background: #e8f5e8; padding: 10px; border-radius: 5px; text-align: center;">
                <strong>24 Ø³Ø§Ø¹Øª Ø§Ø®ÛŒØ±</strong><br>
                <span style="font-size: 20px; color: #28a745;">{{ embedding_stats.recent_embeddings }}</span>
            </div>
            <div class="stat-box" style="background: #fff3e0; padding: 10px; border-radius: 5px; text-align: center;">
                <strong>ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¯Ù„â€ŒÙ‡Ø§</strong><br>
                <span style="font-size: 20px; color: #f57c00;">{{ embedding_stats.models_count }}</span>
            </div>
            <div class="stat-box" style="background: #f3e5f5; padding: 10px; border-radius: 5px; text-align: center;">
                <strong>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù†</strong><br>
                <span style="font-size: 16px; color: #8e24aa;">{{ embedding_stats.avg_time_per_embedding|floatformat:2 }}s</span>
            </div>
        </div>
        
        <!-- Ø¬Ø¯ÙˆÙ„ Ù…Ø¯Ù„â€ŒÙ‡Ø§ -->
        <div style="margin-top: 20px;">
            <h3>ğŸ“Š Ø¬Ø²Ø¦ÛŒØ§Øª Ù‡Ø± Ù…Ø¯Ù„:</h3>
            <div style="background: #e7f3ff; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 14px;">
                <strong>ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§:</strong>
                <span style="color: #28a745;">ğŸ“Š ÙˆØ§Ù‚Ø¹ÛŒ</span> = Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ø² Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Worker Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ |
                <span style="color: #6c757d;">ğŸ“ ØªØ®Ù…ÛŒÙ†ÛŒ</span> = Ø¨Ø± Ø§Ø³Ø§Ø³ Ù¾ÛŒÚ†ÛŒØ¯Ú¯ÛŒ Ù…Ø¯Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡
            </div>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">Ù†Ø§Ù… Ù…Ø¯Ù„</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">ÙˆØ¶Ø¹ÛŒØª</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Ø§Ø¨Ø¹Ø§Ø¯</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Ú©Ù„ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯â€ŒÙ‡Ø§</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">24 Ø³Ø§Ø¹Øª Ø§Ø®ÛŒØ±</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø²Ù…Ø§Ù†/Ø¨Ø±Ø¯Ø§Ø±</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Ù…Ù†Ø¨Ø¹ Ø¯Ø§Ø¯Ù‡</th>
                        <th style="padding: 12px; border: 1px solid #ddd; text-align: center;">Ú©Ù„ Ø²Ù…Ø§Ù† ØªØ®Ù…ÛŒÙ†ÛŒ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for model_stat in embedding_models_stats %}
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold;">
                            {{ model_stat.model_name }}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            {% if model_stat.is_processing %}
                                <span style="color: #ff6b35; font-weight: bold;">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´</span>
                            {% else %}
                                <span style="color: #28a745; font-weight: bold;">âœ… Ø¢Ù…Ø§Ø¯Ù‡</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            {{ model_stat.model_dimension }}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            <span style="color: #0066cc; font-weight: bold;">{{ model_stat.total_embeddings }}</span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            <span style="color: #28a745; font-weight: bold;">{{ model_stat.recent_embeddings }}</span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            <span style="color: #f57c00; font-weight: bold;">{{ model_stat.avg_time_display }}</span>
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            {% if "ÙˆØ§Ù‚Ø¹ÛŒ" in model_stat.timing_source %}
                                <span style="color: #28a745; font-weight: bold; font-size: 12px;">ğŸ“Š {{ model_stat.timing_source }}</span>
                            {% else %}
                                <span style="color: #6c757d; font-weight: bold; font-size: 12px;">ğŸ“ {{ model_stat.timing_source }}</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            <span style="color: #8e24aa; font-weight: bold;">{{ model_stat.estimated_total_time|floatformat:1 }}s</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if embedding_stats.error %}
        <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 5px;">
            <strong style="color: #721c24;">Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±:</strong>
            <span style="color: #721c24;">{{ embedding_stats.error }}</span>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ffc107; border-radius: 5px; background: #fff3cd;">
        <h2 style="color: white;">âš ï¸ Ø¢Ù…Ø§Ø± Ø²Ù…Ø§Ù†ÛŒ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯</h2>
        <p style="color: #856404;">Ù‡ÛŒÚ† Ù…Ø¯Ù„ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯ ÙØ¹Ø§Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ù‡ÛŒÚ† Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯ÛŒ ØªÙˆÙ„ÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    </div>
    {% endif %}

    <!-- task Ù‡Ø§ÛŒ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯ -->
    {% if embedding_tasks %}
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h2 style="color: white;">ğŸ¤– Task Ù‡Ø§ÛŒ Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯ Ø§Ø®ÛŒØ±</h2>
        <div style="max-height: 300px; overflow-y: auto;">
            {% for task in embedding_tasks %}
            <div class="task-item" style="margin-bottom: 10px; padding: 10px; background: {% if task.status == 'completed' %}#d4edda{% else %}#fff3cd{% endif %}; border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>
                        {% if task.status == 'completed' %}
                            âœ… <strong>ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</strong>
                        {% else %}
                            â³ <strong>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§</strong>
                        {% endif %}
                    </span>
                    {% if task.duration %}
                        <span style="color: #666;">â±ï¸ {{ task.duration }}</span>
                    {% endif %}
                </div>
                {% if task.task_id %}
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Task ID: {{ task.task_id }}
                    </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- task Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ± Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ -->
    {% if recent_tasks %}
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h2>ğŸ“‹ task Ù‡Ø§ÛŒ Ø§Ø®ÛŒØ± (24 Ø³Ø§Ø¹Øª Ú¯Ø°Ø´ØªÙ‡)</h2>
        <div style="max-height: 300px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Ù†Ø§Ù… Task</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">ÙˆØ¶Ø¹ÛŒØª</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Ø²Ù…Ø§Ù† Ø§ÛŒØ¬Ø§Ø¯</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">Ø²Ù…Ø§Ù† Ø§ØªÙ…Ø§Ù…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in recent_tasks %}
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ task.task_name|default:"Ù†Ø§Ù…Ø´Ø®Øµ" }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            {% if task.status == 'SUCCESS' %}
                                <span style="color: #28a745;">âœ… Ù…ÙˆÙÙ‚</span>
                            {% elif task.status == 'FAILURE' %}
                                <span style="color: #dc3545;">âŒ Ù†Ø§Ù…ÙˆÙÙ‚</span>
                            {% elif task.status == 'PENDING' %}
                                <span style="color: #ffc107;">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
                            {% else %}
                                <span style="color: #6c757d;">{{ task.status }}</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px; border: 1px solid #ddd;">{{ task.date_created|date:"Y/m/d H:i" }}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">
                            {% if task.date_done %}
                                {{ task.date_done|date:"Y/m/d H:i" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ… Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯ -->
    {% if recent_log_lines %}
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h2>ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… Ø§Ù…Ø¨Ø¯ÛŒÙ†Ú¯</h2>
        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto;">
            <pre style="margin: 0; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; direction: ltr; text-align: left;">{% for line in recent_log_lines %}{{ line }}
{% endfor %}</pre>
        </div>
        <div style="margin-top: 10px; text-align: center;">
            <small style="color: #666;">ğŸ’¡ Ù†Ù…Ø§ÛŒØ´ Ø¢Ø®Ø±ÛŒÙ† {{ recent_log_lines|length }} Ø®Ø· Ø§Ø² Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Worker</small>
        </div>
    </div>
    {% else %}
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #ffc107; border-radius: 5px; background: #fff3cd;">
        <h2 style="color: #856404;">âš ï¸ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Worker</h2>
        <p style="color: #856404;">Ù‡ÛŒÚ† Ù„Ø§Ú¯ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Celery Worker Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø§Ø´Ø¯.</p>
        <div style="margin-top: 10px;">
            <code style="background: #f8f9fa; padding: 5px; border-radius: 3px;">docker compose -f docker-compose.ingest.yml logs worker</code>
        </div>
    </div>
    {% endif %}

    <!-- Ø®Ø·Ø§Ù‡Ø§ -->
    {% if task_error %}
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #dc3545; border-radius: 5px; background: #f8d7da;">
        <h2 style="color: #721c24;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª task Ù‡Ø§</h2>
        <p style="color: #721c24;">{{ task_error }}</p>
    </div>
    {% endif %}

    {% if redis_error %}
    <div class="card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #dc3545; border-radius: 5px; background: #f8d7da;">
        <h2 style="color: #721c24;">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Redis</h2>
        <p style="color: #721c24;">{{ redis_error }}</p>
    </div>
    {% endif %}

</div>

<style>
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn {
    display: inline-block;
    font-weight: 400;
    text-align: center;
    vertical-align: middle;
    cursor: pointer;
    border: 1px solid transparent;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
    border-radius: 0.25rem;
    transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out;
}

.btn:hover {
    opacity: 0.8;
}

.task-item {
    transition: all 0.2s ease;
}

.task-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}
