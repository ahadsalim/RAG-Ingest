{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ÙˆØ¯ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ù…Ø±Ú©Ø²ÛŒ{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
    .node-viewer-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .search-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .search-form {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .search-form input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .search-form button {
        padding: 10px 20px;
        background: #417690;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    
    .search-form button:hover {
        background: #2c5467;
    }
    
    .available-nodes {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .available-nodes h3 {
        margin-top: 0;
        color: #333;
        font-size: 16px;
    }
    
    .node-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .node-list li {
        padding: 8px;
        margin: 5px 0;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .node-list li:hover {
        background: #e9ecef;
    }
    
    .node-list a {
        color: #417690;
        text-decoration: none;
        font-family: monospace;
    }
    
    .node-list a:hover {
        text-decoration: underline;
    }
    
    .node-info {
        font-size: 12px;
        color: #666;
    }
    
    .result-section {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .alert {
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .data-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 15px;
        direction: ltr;
        text-align: left;
    }
    
    .data-display pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 13px;
        font-family: 'Courier New', monospace;
    }
    
    .metadata-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .metadata-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .metadata-item strong {
        display: block;
        color: #417690;
        margin-bottom: 5px;
    }
    
    .metadata-item code {
        background: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .vector-preview {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 12px;
        font-family: monospace;
    }
    
    .chunk-info-box {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .chunk-info-box h3 {
        margin-top: 0;
        color: #0056b3;
    }
    
    .info-section {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .info-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        font-size: 18px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
    }
</style>
{% endblock %}

{% block content %}
<div class="node-viewer-container">
    <div class="search-section">
        <form method="get" class="search-form">
            <input type="text" 
                   name="node_id" 
                   placeholder="Node ID Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (UUID)" 
                   value="{{ requested_node_id|default:'' }}"
                   pattern="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}"
                   required>
            <button type="submit">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
        </form>
        
        <div class="available-nodes">
            <h3>ğŸ“‹ Ù„ÛŒØ³Øª Node ID Ù‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ ({{ available_nodes.count }} Ø¹Ø¯Ø¯)</h3>
            <ul class="node-list">
                {% for chunk in available_nodes %}
                <li>
                    <a href="?node_id={{ chunk.node_id }}">{{ chunk.node_id }}</a>
                    <span class="node-info">
                        {% if chunk.unit %}
                            Ø§Ø² LegalUnit
                        {% elif chunk.qaentry %}
                            Ø§Ø² QAEntry
                        {% endif %}
                        | {{ chunk.chunk_text|truncatechars:50 }}
                    </span>
                </li>
                {% empty %}
                <li style="color: #666;">Ù‡ÛŒÚ† Node Ø¨Ø§ node_id ÛŒØ§ÙØª Ù†Ø´Ø¯</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
    {% if error %}
    <div class="alert alert-error">
        <strong>âŒ Ø®Ø·Ø§:</strong> {{ error }}
    </div>
    {% endif %}
    
    {% if node_data %}
    <div class="alert alert-success">
        âœ… Node Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø² Core Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯
    </div>
    
    {% if chunk %}
    <div class="chunk-info-box">
        <h3>ğŸ“¦ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Chunk Ù…Ø±ØªØ¨Ø· (Ù…Ø­Ù„ÛŒ)</h3>
        <div class="metadata-grid">
            <div class="metadata-item">
                <strong>Chunk ID:</strong>
                <code>{{ chunk.id }}</code>
            </div>
            {% if chunk.unit %}
            <div class="metadata-item">
                <strong>Ù…Ù†Ø¨Ø¹:</strong>
                LegalUnit: <code>{{ chunk.unit_id }}</code>
            </div>
            {% elif chunk.qaentry %}
            <div class="metadata-item">
                <strong>Ù…Ù†Ø¨Ø¹:</strong>
                QAEntry: <code>{{ chunk.qaentry_id }}</code>
            </div>
            {% endif %}
            <div class="metadata-item">
                <strong>ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø§Ú©ØªØ±:</strong>
                {{ chunk.chunk_text|length }}
            </div>
            <div class="metadata-item">
                <strong>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:</strong>
                {{ chunk.created_at|date:"Y-m-d H:i" }}
            </div>
        </div>
        <div class="data-display" style="margin-top: 10px;">
            <strong>Ù…ØªÙ† Chunk:</strong>
            <p>{{ chunk.chunk_text }}</p>
        </div>
    </div>
    {% endif %}
    
    <div class="result-section">
        <h2>â˜ï¸ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Node Ø¯Ø± Core</h2>
        {% with core=node_data.node payload=node_data.node.payload metadata=node_data.node.payload.metadata vectors=node_data.node.vectors %}
        
        <!-- Basic IDs & status -->
        <div class="info-section">
            <h3>ğŸ†” Ø´Ù†Ø§Ø³Ù‡â€ŒÙ‡Ø§ Ùˆ ÙˆØ¶Ø¹ÛŒØª</h3>
            <div class="metadata-grid">
                <div class="metadata-item">
                    <strong>ÙˆØ¶Ø¹ÛŒØª Ù¾Ø§Ø³Ø®:</strong>
                    {{ node_data.status|default:"-" }}
                </div>
                <div class="metadata-item">
                    <strong>Node ID:</strong>
                    <code>{{ core.id }}</code>
                </div>
                {% if payload.document_id %}
                <div class="metadata-item">
                    <strong>Document ID:</strong>
                    <code>{{ payload.document_id }}</code>
                </div>
                {% endif %}
                {% if metadata.work_id %}
                <div class="metadata-item">
                    <strong>Work ID:</strong>
                    <code>{{ metadata.work_id }}</code>
                </div>
                {% endif %}
                {% if metadata.unit_id %}
                <div class="metadata-item">
                    <strong>Unit ID:</strong>
                    <code>{{ metadata.unit_id }}</code>
                </div>
                {% endif %}
                {% if metadata.chunk_id %}
                <div class="metadata-item">
                    <strong>Chunk ID:</strong>
                    <code>{{ metadata.chunk_id }}</code>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Document & content info -->
        <div class="info-section">
            <h3>ğŸ“„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ù†Ø¯ Ùˆ Ù…Ø­ØªÙˆØ§</h3>
            <div class="metadata-grid">
                {% if metadata.work_title %}
                <div class="metadata-item" style="grid-column: 1 / -1;">
                    <strong>Ø¹Ù†ÙˆØ§Ù† Ø³Ù†Ø¯:</strong>
                    {{ metadata.work_title }}
                </div>
                {% endif %}
                {% if payload.document_type %}
                <div class="metadata-item">
                    <strong>Ù†ÙˆØ¹ Ø³Ù†Ø¯:</strong>
                    {{ payload.document_type|default:"-" }}
                </div>
                {% endif %}
                {% if metadata.urn_lex %}
                <div class="metadata-item">
                    <strong>URN LEX:</strong>
                    <code>{{ metadata.urn_lex }}</code>
                </div>
                {% endif %}
                {% if payload.language %}
                <div class="metadata-item">
                    <strong>Ø²Ø¨Ø§Ù†:</strong>
                    {{ payload.language }}
                </div>
                {% endif %}
                {% if metadata.path_label %}
                <div class="metadata-item">
                    <strong>Path Label:</strong>
                    {{ metadata.path_label }}
                </div>
                {% endif %}
                {% if metadata.unit_type or metadata.unit_number %}
                <div class="metadata-item">
                    <strong>ÙˆØ§Ø­Ø¯:</strong>
                    {{ metadata.unit_type|default:"" }} {{ metadata.unit_number|default:"" }}
                </div>
                {% endif %}
                {% if payload.chunk_index %}
                <div class="metadata-item">
                    <strong>Chunk Index:</strong>
                    {{ payload.chunk_index }}
                </div>
                {% endif %}
                {% if payload.created_at %}
                <div class="metadata-item">
                    <strong>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø± Core:</strong>
                    {{ payload.created_at }}
                </div>
                {% endif %}
            </div>
            {% if payload.text %}
            <div class="data-display">
                <strong>Ù…ØªÙ†:</strong>
                <p style="background: #f8f9fa; padding: 15px; border-radius: 4px; line-height: 1.8;">{{ payload.text }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Legal & validity info -->
        {% if metadata.jurisdiction or metadata.authority or metadata.valid_from or metadata.valid_to or metadata.in_force_from or metadata.in_force_to or metadata.repeal_status %}
        <div class="info-section">
            <h3>âš–ï¸ Ø§Ø¹ØªØ¨Ø§Ø± Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ù‚ÙˆÙ‚ÛŒ</h3>
            <div class="metadata-grid">
                {% if metadata.jurisdiction %}
                <div class="metadata-item">
                    <strong>Ø­ÙˆØ²Ù‡ Ù‚Ø¶Ø§ÛŒÛŒ:</strong>
                    {{ metadata.jurisdiction }}
                </div>
                {% endif %}
                {% if metadata.authority %}
                <div class="metadata-item">
                    <strong>Ù…Ø±Ø¬Ø¹:</strong>
                    {{ metadata.authority }}
                </div>
                {% endif %}
                {% if metadata.valid_from %}
                <div class="metadata-item">
                    <strong>Ù…Ø¹ØªØ¨Ø± Ø§Ø²:</strong>
                    {{ metadata.valid_from }}
                </div>
                {% endif %}
                {% if metadata.valid_to %}
                <div class="metadata-item">
                    <strong>Ù…Ø¹ØªØ¨Ø± ØªØ§:</strong>
                    {{ metadata.valid_to }}
                </div>
                {% endif %}
                {% if metadata.in_force_from %}
                <div class="metadata-item">
                    <strong>Ù„Ø§Ø²Ù…â€ŒØ§Ù„Ø§Ø¬Ø±Ø§ Ø§Ø²:</strong>
                    {{ metadata.in_force_from }}
                </div>
                {% endif %}
                {% if metadata.in_force_to %}
                <div class="metadata-item">
                    <strong>Ù„Ø§Ø²Ù…â€ŒØ§Ù„Ø§Ø¬Ø±Ø§ ØªØ§:</strong>
                    {{ metadata.in_force_to }}
                </div>
                {% endif %}
                {% if metadata.repeal_status %}
                <div class="metadata-item">
                    <strong>ÙˆØ¶Ø¹ÛŒØª Ù†Ø³Ø®:</strong>
                    {{ metadata.repeal_status }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Technical & embedding info -->
        {% if metadata.token_count or metadata.chunk_hash or metadata.embedding_model or metadata.embedding_dimension or metadata.content_type or payload.source %}
        <div class="info-section">
            <h3>ğŸ”§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù†ÛŒÚ©Ø§Ù„ Ùˆ Embedding</h3>
            <div class="metadata-grid">
                {% if metadata.token_count %}
                <div class="metadata-item">
                    <strong>ØªØ¹Ø¯Ø§Ø¯ Token:</strong>
                    {{ metadata.token_count }}
                </div>
                {% endif %}
                {% if metadata.overlap_prev %}
                <div class="metadata-item">
                    <strong>Overlap Ø¨Ø§ Ù‚Ø¨Ù„ÛŒ:</strong>
                    {{ metadata.overlap_prev }}
                </div>
                {% endif %}
                {% if metadata.chunk_hash %}
                <div class="metadata-item">
                    <strong>Chunk Hash:</strong>
                    <code>{{ metadata.chunk_hash|truncatechars:32 }}</code>
                </div>
                {% endif %}
                {% if payload.source %}
                <div class="metadata-item">
                    <strong>Ù…Ù†Ø¨Ø¹ Ø³ÛŒØ³ØªÙ…:</strong>
                    {{ payload.source }}
                </div>
                {% endif %}
                {% if metadata.content_type %}
                <div class="metadata-item">
                    <strong>Ù†ÙˆØ¹ Ù…Ø­ØªÙˆØ§:</strong>
                    {{ metadata.content_type }}
                </div>
                {% endif %}
                {% if metadata.embedding_model %}
                <div class="metadata-item" style="grid-column: 1 / -1;">
                    <strong>Ù…Ø¯Ù„ Embedding:</strong>
                    <code>{{ metadata.embedding_model }}</code>
                </div>
                {% endif %}
                {% if metadata.embedding_dimension %}
                <div class="metadata-item">
                    <strong>Ø§Ø¨Ø¹Ø§Ø¯ Ø¨Ø±Ø¯Ø§Ø±:</strong>
                    {{ metadata.embedding_dimension }}
                </div>
                {% endif %}
                {% if metadata.embedding_created_at %}
                <div class="metadata-item">
                    <strong>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯ Embedding:</strong>
                    {{ metadata.embedding_created_at }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Metadata dump as generic table -->
        {% if metadata %}
        <div class="info-section">
            <h3>ğŸ“¦ Ø³Ø§ÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Metadata</h3>
            <div class="data-display">
                <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background:#f0f0f0;">
                            <th style="padding:8px; border:1px solid #ddd; text-align:right;">Ú©Ù„ÛŒØ¯</th>
                            <th style="padding:8px; border:1px solid #ddd; text-align:left;">Ù…Ù‚Ø¯Ø§Ø±</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key, value in metadata.items %}
                            {% if value %}
                            <tr>
                                <td style="padding:6px; border:1px solid #eee; text-align:right; white-space:nowrap;">{{ key }}</td>
                                <td style="padding:6px; border:1px solid #eee; text-align:left; direction:ltr;">
                                    {{ value }}
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Vectors summary -->
        {% if vectors %}
        <div class="info-section">
            <h3>ğŸ”¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª VectorÙ‡Ø§</h3>
            <div class="data-display">
                <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background:#f0f0f0;">
                            <th style="padding:8px; border:1px solid #ddd; text-align:right;">Ù†Ø§Ù… Ø¨Ø±Ø¯Ø§Ø±</th>
                            <th style="padding:8px; border:1px solid #ddd; text-align:left;">ØªØ¹Ø¯Ø§Ø¯ Ø§Ø¨Ø¹Ø§Ø¯</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for vname, vvals in vectors.items %}
                        <tr>
                            <td style="padding:6px; border:1px solid #eee; text-align:right;">{{ vname }}</td>
                            <td style="padding:6px; border:1px solid #eee; text-align:left;">{{ vvals|length }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Raw JSON Section -->
        <div class="info-section">
            <h3>ğŸ” JSON Ø®Ø§Ù… (Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù†)</h3>
            <details>
                <summary style="cursor: pointer; padding: 10px; background: #f0f0f0; border-radius: 4px;">
                    <strong>â–¶ Ù†Ù…Ø§ÛŒØ´ JSON Ú©Ø§Ù…Ù„</strong>
                </summary>
                <div class="data-display" style="margin-top: 10px;">
                    <pre style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 4px; max-height: 600px; overflow: auto; font-size: 12px;">{{ node_json|default:node_data|safe }}</pre>
                </div>
            </details>
        </div>
        {% endwith %}
    </div>
    {% endif %}
    
    {% if not requested_node_id %}
    <div class="result-section">
        <p style="text-align: center; color: #666; font-size: 16px;">
            ğŸ‘† ÛŒÚ© Node ID Ø§Ø² Ù„ÛŒØ³Øª Ø¨Ø§Ù„Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ ÙˆØ§Ø±Ø¯ Ù†Ù…Ø§ÛŒÛŒØ¯
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}
