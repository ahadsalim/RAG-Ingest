{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list ingest_jalali %}

{% block title %}Ú¯Ø²Ø§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
.report-filters {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.report-summary {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.report-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
.report-table th, .report-table td {
    padding: 12px;
    text-align: right;
    border-bottom: 1px solid #ddd;
}
.report-table th {
    background-color: #f5f5f5;
    font-weight: bold;
}
.report-table tr:hover {
    background-color: #f9f9f9;
}
.export-buttons {
    margin: 20px 0;
}
.export-buttons a {
    margin-left: 10px;
    padding: 8px 16px;
    background: #007cba;
    color: white;
    text-decoration: none;
    border-radius: 4px;
}
.export-buttons a:hover {
    background: #005a87;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    text-align: center;
}
.stat-number {
    font-size: 24px;
    font-weight: bold;
    color: #007cba;
}
.stat-label {
    color: #666;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="module">
    <h1>ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>
    
    <!-- Filters -->
    <div class="report-filters">
        <h3>ğŸ” ÙÛŒÙ„ØªØ±Ù‡Ø§ (ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ)</h3>
        <form method="get" style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
            {% if form %}
                {% for field in form %}
                    <div>
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label><br>
                        {{ field }}
                        {% if field.help_text %}
                            <small class="jalali-date-help">{{ field.help_text }}</small>
                        {% endif %}
                        {% if field.errors %}
                            <div class="jalali-date-error">{{ field.errors.0 }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div>
                    <label for="start_date">Ø§Ø² ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ):</label><br>
                    <input type="text" id="start_date" name="start_date" value="{{ start_date|jalali_date }}" 
                           class="form-control jalali-date-input" placeholder="1402/01/01" required>
                </div>
                <div>
                    <label for="end_date">ØªØ§ ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ):</label><br>
                    <input type="text" id="end_date" name="end_date" value="{{ end_date|jalali_date }}" 
                           class="form-control jalali-date-input" placeholder="1402/12/29" required>
                </div>
                <div>
                    <label for="user">Ú©Ø§Ø±Ø¨Ø± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</label><br>
                    <select id="user" name="user" class="form-control">
                        <option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>
                        {% for user in all_users %}
                            <option value="{{ user.id }}" {% if selected_user == user.id|stringformat:"s" %}selected{% endif %}>
                                {{ user.get_full_name|default:user.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            <div>
                <button type="submit" class="default">ğŸ” Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</button>
            </div>
        </form>
    </div>

    <!-- Summary Statistics -->
    <div class="report-summary">
        <h3>ğŸ“ˆ Ø®Ù„Ø§ØµÙ‡ Ø¢Ù…Ø§Ø± ({{ start_date|jalali_date }} ØªØ§ {{ end_date|jalali_date }})</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ user_count }}</div>
                <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_work_hours }}</div>
                <div class="stat-label">Ú©Ù„ Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ total_activities }}</div>
                <div class="stat-label">Ú©Ù„ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ avg_work_hours }}</div>
                <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø§Ø¹Øª Ú©Ø§Ø±</div>
            </div>
        </div>
    </div>

    <!-- Export Buttons -->
    <div class="export-buttons">
        <h3>ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´</h3>
        <a href="{% url 'admin:accounts_export_csv' %}?start_date={{ start_date|date:'Y-m-d' }}&end_date={{ end_date|date:'Y-m-d' }}{% if selected_user %}&user={{ selected_user }}{% endif %}" 
           class="button">ğŸ“Š Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV</a>
        <a href="#" onclick="window.print()" class="button">ğŸ–¨ï¸ Ú†Ø§Ù¾ Ú¯Ø²Ø§Ø±Ø´</a>
    </div>

    <!-- Detailed Report Table -->
    {% if report_data %}
    <div class="results">
        <h3>ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯Ø²Ø§Ø±Ø´</h3>
        <table class="report-table">
            <thead>
                <tr>
                    <th>ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±</th>
                    <th>â° Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±</th>
                    <th>ğŸ“… Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±</th>
                    <th>ğŸ“Š Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡</th>
                    <th>ğŸ”— Ø¬Ù„Ø³Ø§Øª</th>
                    <th>ğŸ“ Ú©Ù„ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§</th>
                    <th>ğŸ” Ø¬Ø²Ø¦ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody>
                {% for data in report_data %}
                <tr>
                    <td>
                        <strong>{{ data.user.get_full_name|default:data.user.username }}</strong><br>
                        <small style="color: #666;">{{ data.user.username }}</small>
                    </td>
                    <td><strong>{{ data.total_work_hours }}</strong></td>
                    <td>{{ data.work_days }}</td>
                    <td>{{ data.avg_hours_per_day }}</td>
                    <td>{{ data.total_sessions }}</td>
                    <td><strong>{{ data.total_activities }}</strong></td>
                    <td>
                        <details>
                            <summary style="cursor: pointer; color: #007cba;">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª</summary>
                            <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <div>ğŸ”‘ ÙˆØ±ÙˆØ¯: <strong>{{ data.login_count }}</strong></div>
                                    <div>ğŸšª Ø®Ø±ÙˆØ¬: <strong>{{ data.logout_count }}</strong></div>
                                    <div>â• Ø§ÛŒØ¬Ø§Ø¯: <strong>{{ data.create_count }}</strong></div>
                                    <div>âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´: <strong>{{ data.update_count }}</strong></div>
                                    <div>ğŸ—‘ï¸ Ø­Ø°Ù: <strong>{{ data.delete_count }}</strong></div>
                                    <div>ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡: <strong>{{ data.view_count }}</strong></div>
                                </div>
                            </div>
                        </details>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="results">
        <p style="text-align: center; padding: 40px; color: #666;">
            ğŸ“­ Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.
        </p>
    </div>
    {% endif %}
</div>

<script>
// Auto-refresh functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add some interactivity if needed
    const detailsElements = document.querySelectorAll('details');
    detailsElements.forEach(details => {
        details.addEventListener('toggle', function() {
            if (this.open) {
                // Close other details when one is opened
                detailsElements.forEach(other => {
                    if (other !== this) other.open = false;
                });
            }
        });
    });
});
</script>
{% endblock %}
