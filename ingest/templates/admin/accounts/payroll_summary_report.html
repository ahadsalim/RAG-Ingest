{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Ø®Ø§Ù†Ù‡</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div class="module">
    <h1>ğŸ’° {{ title }}</h1>
    
    <!-- Filters Section -->
    <div class="module filtered" style="margin-bottom: 20px;">
        <h2>ğŸ” ÙÛŒÙ„ØªØ±Ù‡Ø§</h2>
        <form method="get" class="form-horizontal" style="padding: 15px;">
            {% csrf_token %}
            <div class="form-row">
                <div class="field-box">
                    <label for="id_month">Ù…Ø§Ù‡:</label>
                    <input type="month" name="month" id="id_month" value="{{ month }}" class="vDateField">
                </div>
                <div class="field-box">
                    <label for="id_user_id">Ú©Ø§Ø±Ø¨Ø±:</label>
                    <select name="user_id" id="id_user_id">
                        <option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>
                        {% for user in all_users %}
                            <option value="{{ user.id }}" {% if user.id|stringformat:"s" == user_id %}selected{% endif %}>
                                {{ user.username }} ({{ user.get_full_name|default:user.username }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-row">
                <input type="submit" value="ğŸ” Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´" class="default">
                <input type="submit" name="export" value="csv" class="default" style="margin-left: 10px;" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV">
            </div>
        </form>
    </div>

    <!-- Summary Stats -->
    <div class="module" style="margin-bottom: 20px;">
        <h2>ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ø¢Ù…Ø§Ø± Ù…Ø§Ù‡Ø§Ù†Ù‡</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; padding: 15px;">
            <div class="dashboard-stat salary-stat">
                <div class="stat-number">{{ total_salary_budget|floatformat:0 }}</div>
                <div class="stat-label">Ú©Ù„ Ø¨ÙˆØ¯Ø¬Ù‡ Ø­Ù‚ÙˆÙ‚ (ØªÙˆÙ…Ø§Ù†)</div>
            </div>
            <div class="dashboard-stat">
                <div class="stat-number">{{ total_employees }}</div>
                <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</div>
            </div>
            <div class="dashboard-stat">
                <div class="stat-number">{{ avg_hours_per_employee }}</div>
                <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±</div>
            </div>
            <div class="dashboard-stat">
                <div class="stat-number">{{ avg_attendance }}%</div>
                <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù†Ø±Ø® Ø­Ø¶ÙˆØ±</div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    {% if payroll_data %}
    <div class="module">
        <h2>ğŸ’¼ Ø¬Ø¯ÙˆÙ„ Ø­Ù‚ÙˆÙ‚ Ùˆ Ø¯Ø³ØªÙ…Ø²Ø¯</h2>
        <div class="results">
            <table id="payroll_table">
                <thead>
                    <tr>
                        <th scope="col">Ú©Ø§Ø±Ø¨Ø±</th>
                        <th scope="col">Ù†Ø§Ù… Ú©Ø§Ù…Ù„</th>
                        <th scope="col">Ú©Ù„ Ø³Ø§Ø¹Ø§Øª</th>
                        <th scope="col">Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ</th>
                        <th scope="col">Ù†Ø±Ø® Ø­Ø¶ÙˆØ±</th>
                        <th scope="col">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡</th>
                        <th scope="col">Ù†Ø±Ø® Ø³Ø§Ø¹ØªÛŒ</th>
                        <th scope="col">Ø­Ù‚ÙˆÙ‚ Ù¾Ø§ÛŒÙ‡</th>
                        <th scope="col">Ù¾Ø§Ø¯Ø§Ø´/Ø¬Ø±ÛŒÙ…Ù‡</th>
                        <th scope="col">Ø­Ù‚ÙˆÙ‚ Ù†Ù‡Ø§ÛŒÛŒ</th>
                        <th scope="col">Ø¬Ø²Ø¦ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in payroll_data %}
                    <tr class="{% cycle 'row1' 'row2' %}">
                        <td><strong>{{ row.user }}</strong></td>
                        <td>{{ row.full_name }}</td>
                        <td class="hours-cell">{{ row.total_hours }} Ø³Ø§Ø¹Øª</td>
                        <td>{{ row.worked_days }}/{{ row.working_days }}</td>
                        <td>
                            <span class="attendance-badge {% if row.attendance_rate >= 95 %}excellent{% elif row.attendance_rate >= 80 %}good{% else %}poor{% endif %}">
                                {{ row.attendance_rate }}%
                            </span>
                        </td>
                        <td>{{ row.avg_daily_hours }} Ø³Ø§Ø¹Øª</td>
                        <td class="currency">{{ row.hourly_rate|floatformat:0 }}</td>
                        <td class="currency">{{ row.gross_salary|floatformat:0 }}</td>
                        <td class="currency {% if row.attendance_bonus > 0 %}positive{% elif row.attendance_bonus < 0 %}negative{% endif %}">
                            {{ row.attendance_bonus|floatformat:0 }}
                        </td>
                        <td class="currency final-salary">{{ row.final_salary|floatformat:0 }}</td>
                        <td>
                            <button class="details-btn" onclick="togglePayrollDetails('{{ row.user }}')">
                                Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª
                            </button>
                            <div id="payroll_details_{{ row.user }}" class="payroll-details" style="display: none;">
                                <h4>ØªÙÚ©ÛŒÚ© Ø±ÙˆØ²Ø§Ù†Ù‡ Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±:</h4>
                                {% for date, hours in row.daily_breakdown.items %}
                                    <div class="daily-item">
                                        <span class="date">{{ date }}</span>
                                        <span class="hours">{{ hours|floatformat:2 }} Ø³Ø§Ø¹Øª</span>
                                    </div>
                                {% empty %}
                                    <p>Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="7"><strong>Ø¬Ù…Ø¹ Ú©Ù„:</strong></td>
                        <td class="currency"><strong>{{ payroll_data|length|add:0 }}</strong></td>
                        <td class="currency"><strong>-</strong></td>
                        <td class="currency final-salary"><strong>{{ total_salary_budget|floatformat:0 }}</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Export Actions -->
        <div class="actions" style="margin-top: 15px;">
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="month" value="{{ month }}">
                <input type="hidden" name="user_id" value="{{ user_id }}">
                <input type="submit" name="export" value="csv" class="default" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ CSV">
            </form>
        </div>
    </div>
    {% else %}
    <div class="module">
        <p style="text-align: center; padding: 40px; color: #666;">
            ğŸ“­ Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.
            <br>
            Ù„Ø·ÙØ§Ù‹ Ù…Ø§Ù‡ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ù…Ù†Ø§Ø³Ø¨ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.
        </p>
    </div>
    {% endif %}

    <!-- Salary Calculation Notes -->
    <div class="module" style="margin-top: 20px;">
        <h2>ğŸ“ Ù†Ú©Ø§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚</h2>
        <div style="padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <ul style="margin: 0; padding-right: 20px;">
                <li><strong>Ù†Ø±Ø® Ø³Ø§Ø¹ØªÛŒ:</strong> 50,000 ØªÙˆÙ…Ø§Ù† (Ù‚Ø§Ø¨Ù„ ØªÙ†Ø¸ÛŒÙ…)</li>
                <li><strong>Ù¾Ø§Ø¯Ø§Ø´ Ø­Ø¶ÙˆØ±:</strong> 10% Ø¨Ø±Ø§ÛŒ Ø­Ø¶ÙˆØ± Ø¨Ø§Ù„Ø§ÛŒ 95%</li>
                <li><strong>Ø¬Ø±ÛŒÙ…Ù‡ ØºÛŒØ¨Øª:</strong> 5% Ø¨Ø±Ø§ÛŒ Ø­Ø¶ÙˆØ± Ú©Ù…ØªØ± Ø§Ø² 80%</li>
                <li><strong>Ø­Ø¯Ø§Ú©Ø«Ø± Ø³Ø§Ø¹Ø§Øª Ø±ÙˆØ²Ø§Ù†Ù‡:</strong> 10 Ø³Ø§Ø¹Øª</li>
                <li><strong>Ø­Ø¯Ø§Ù‚Ù„ Ø²Ù…Ø§Ù† Ø¬Ù„Ø³Ù‡:</strong> 15 Ø¯Ù‚ÛŒÙ‚Ù‡</li>
                <li><strong>Ø±ÙˆØ²Ù‡Ø§ÛŒ Ú©Ø§Ø±ÛŒ:</strong> Ø´Ù†Ø¨Ù‡ ØªØ§ Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</li>
            </ul>
        </div>
    </div>
</div>

<style>
.dashboard-stat {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.salary-stat {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.salary-stat .stat-number {
    color: white;
}

.stat-number {
    font-size: 28px;
    font-weight: bold;
    color: #007cba;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 14px;
}

.salary-stat .stat-label {
    color: rgba(255,255,255,0.9);
}

.form-horizontal .form-row {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

.form-horizontal .field-box {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}

.form-horizontal .field-box label {
    margin-bottom: 5px;
    font-weight: bold;
}

.form-horizontal input, .form-horizontal select {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* Attendance Badges */
.attendance-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 12px;
}

.attendance-badge.excellent {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.attendance-badge.good {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.attendance-badge.poor {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Currency formatting */
.currency {
    text-align: right;
    font-family: 'Courier New', monospace;
    font-weight: bold;
}

.currency.positive {
    color: #28a745;
}

.currency.negative {
    color: #dc3545;
}

.final-salary {
    background-color: #e8f5e8;
    font-size: 14px;
}

/* Table styling */
#payroll_table th {
    background-color: #f8f9fa;
    font-weight: bold;
    text-align: center;
    padding: 12px 8px;
    border-bottom: 2px solid #dee2e6;
}

#payroll_table td {
    text-align: center;
    padding: 10px 8px;
    vertical-align: middle;
    border-bottom: 1px solid #dee2e6;
}

#payroll_table .total-row {
    background-color: #f8f9fa;
    font-weight: bold;
    border-top: 2px solid #007cba;
}

/* Details button and panel */
.details-btn {
    background: #17a2b8;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
}

.details-btn:hover {
    background: #138496;
}

.payroll-details {
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 12px;
    text-align: left;
}

.daily-item {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    border-bottom: 1px solid #eee;
}

.daily-item:last-child {
    border-bottom: none;
}

.daily-item .date {
    font-weight: bold;
}

.daily-item .hours {
    color: #007cba;
}

/* Responsive design */
@media (max-width: 1400px) {
    #payroll_table {
        font-size: 12px;
    }
    
    #payroll_table th, #payroll_table td {
        padding: 6px 4px;
    }
}

@media (max-width: 1000px) {
    .dashboard-stat {
        min-width: 200px;
    }
    
    .stat-number {
        font-size: 24px;
    }
}
</style>

<script>
function togglePayrollDetails(userId) {
    const detailsDiv = document.getElementById('payroll_details_' + userId);
    const button = event.target;
    
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        button.textContent = 'Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¬Ø²Ø¦ÛŒØ§Øª';
        button.style.backgroundColor = '#dc3545';
    } else {
        detailsDiv.style.display = 'none';
        button.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª';
        button.style.backgroundColor = '#17a2b8';
    }
}

// Format currency numbers
document.addEventListener('DOMContentLoaded', function() {
    const currencyCells = document.querySelectorAll('.currency');
    currencyCells.forEach(cell => {
        const value = cell.textContent.trim();
        if (value && !isNaN(value.replace(/[,\s]/g, ''))) {
            const number = parseInt(value.replace(/[,\s]/g, ''));
            cell.textContent = number.toLocaleString('fa-IR');
        }
    });
});
</script>

{% endblock %}
