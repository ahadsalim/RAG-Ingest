{% extends "admin/base_site.html" %}
{% load static jalali %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">Ø®Ø§Ù†Ù‡</a>
    &rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<div class="module">
    <h1>ğŸ“Š {{ title }}</h1>
    
    <!-- Filters Section -->
    <div class="module filtered" style="margin-bottom: 20px;">
        <h2>ğŸ” ÙÛŒÙ„ØªØ±Ù‡Ø§</h2>
        <form method="get" class="form-horizontal" style="padding: 15px;">
            {% csrf_token %}
            <div class="form-row">
                <div class="field-box">
                    <label for="id_from">Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
                    <input type="date" name="from" id="id_from" value="{{ from_date }}" class="vDateField">
                </div>
                <div class="field-box">
                    <label for="id_to">ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
                    <input type="date" name="to" id="id_to" value="{{ to_date }}" class="vDateField">
                </div>
                <div class="field-box">
                    <label for="id_user_id">Ú©Ø§Ø±Ø¨Ø±:</label>
                    <select name="user_id" id="id_user_id">
                        <option value="">Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</option>
                        {% for user in all_users %}
                            <option value="{{ user.id }}" {% if user.id|stringformat:"s" == user_id %}selected{% endif %}>
                                {{ user.username }} ({{ user.get_full_name|default:user.username }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-row">
                <input type="submit" value="ğŸ” Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´" class="default">
                <input type="submit" name="export" value="csv" class="default" style="margin-left: 10px;" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ CSV">
            </div>
        </form>
    </div>

    <!-- Summary Stats -->
    <div class="module" style="margin-bottom: 20px;">
        <h2>ğŸ“ˆ Ø®Ù„Ø§ØµÙ‡ Ø¢Ù…Ø§Ø±</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 15px;">
            <div class="dashboard-stat">
                <div class="stat-number">{{ user_count }}</div>
                <div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div>
            </div>
            <div class="dashboard-stat">
                <div class="stat-number">{{ total_activities }}</div>
                <div class="stat-label">Ú©Ù„ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§</div>
            </div>
            <div class="dashboard-stat">
                <div class="stat-number">{{ total_work_hours }}</div>
                <div class="stat-label">Ú©Ù„ Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±</div>
            </div>
            <div class="dashboard-stat">
                <div class="stat-number">{{ avg_work_hours }}</div>
                <div class="stat-label">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±</div>
            </div>
        </div>
    </div>

    <!-- Results Table -->
    {% if report_data %}
    <div class="module">
        <h2>ğŸ“‹ Ù†ØªØ§ÛŒØ¬ Ú¯Ø²Ø§Ø±Ø´ ({{ report_data|length }} Ø±Ú©ÙˆØ±Ø¯)</h2>
        <div class="results">
            <table id="result_list">
                <thead>
                    <tr>
                        <th scope="col">Ú©Ø§Ø±Ø¨Ø±</th>
                        <th scope="col">ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ</th>
                        <th scope="col">ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ</th>
                        <th scope="col">Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±</th>
                        <th scope="col">ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§</th>
                        <th scope="col">ØªØ¹Ø¯Ø§Ø¯ ÙˆØ±ÙˆØ¯</th>
                        <th scope="col">Ø§ÙˆÙ„ÛŒÙ† ÙˆØ±ÙˆØ¯</th>
                        <th scope="col">Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÙˆØ¬</th>
                        <th scope="col">Ù…Ø¯Øª Ú©Ù„</th>
                        <th scope="col">Ø¬Ø²Ø¦ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in report_data %}
                    <tr class="{% cycle 'row1' 'row2' %}">
                        <td><strong>{{ row.user }}</strong></td>
                        <td>{{ row.date_str }}</td>
                        <td class="jalali-date">{{ row.date|jalali }}</td>
                        <td class="work-hours">
                            <span class="hours-badge {% if row.work_hours >= 8 %}full-time{% elif row.work_hours >= 4 %}part-time{% else %}minimal{% endif %}">
                                {{ row.work_hours }} Ø³Ø§Ø¹Øª
                            </span>
                        </td>
                        <td>{{ row.activities }}</td>
                        <td>{{ row.login_count }}</td>
                        <td>{{ row.first_login }}</td>
                        <td>{{ row.last_logout }}</td>
                        <td>{{ row.total_duration_str }}</td>
                        <td>
                            {% if row.sessions_detail %}
                                <button class="session-details-btn" onclick="toggleDetails('{{ row.user }}_{{ row.date }}')">
                                    Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª
                                </button>
                                <div id="details_{{ row.user }}_{{ row.date }}" class="session-details" style="display: none;">
                                    {% for session in row.sessions_detail %}
                                        <div class="session-item">
                                            <strong>Ø¬Ù„Ø³Ù‡ {{ forloop.counter }}:</strong><br>
                                            ÙˆØ±ÙˆØ¯: {{ session.login|date:"H:i" }}<br>
                                            {% if session.logout %}
                                                Ø®Ø±ÙˆØ¬: {{ session.logout|date:"H:i" }}<br>
                                                Ù…Ø¯Øª: {{ session.duration|default:"Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø´Ø¯Ù‡" }}<br>
                                            {% else %}
                                                Ø®Ø±ÙˆØ¬: Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡<br>
                                            {% endif %}
                                            ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§: {{ session.activities }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="no-sessions">Ø¨Ø¯ÙˆÙ† Ø¬Ù„Ø³Ù‡</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Export Actions -->
        <div class="actions" style="margin-top: 15px;">
            <form method="post" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="from" value="{{ from_date }}">
                <input type="hidden" name="to" value="{{ to_date }}">
                <input type="hidden" name="user_id" value="{{ user_id }}">
                <input type="submit" name="export" value="csv" class="default" title="Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ CSV">
            </form>
        </div>
    </div>
    {% else %}
    <div class="module">
        <div style="text-align: center; padding: 60px 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“Š</div>
            <h3 style="color: #666; margin-bottom: 10px;">Ù‡ÛŒÚ† Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</h3>
            <p style="color: #999; margin-bottom: 20px;">
                Ø¯Ø± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ ({{ from_date }} ØªØ§ {{ to_date }})
                {% if selected_user %}
                    Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± <strong>{{ selected_user.username }}</strong>
                {% endif %}
                Ù‡ÛŒÚ† ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.
            </p>
            <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: 0 auto; text-align: right;">
                <h4 style="margin-top: 0; color: #333;">ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ:</h4>
                <ul style="color: #666; line-height: 1.8;">
                    <li>Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</li>
                    <li>ÙÛŒÙ„ØªØ± Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø±ÛŒØ¯ ØªØ§ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯</li>
                    <li>Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª ÙØ¹Ø§Ù„ÛŒØª ÙØ¹Ø§Ù„ Ø§Ø³Øª</li>
                    <li>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± Ø¬Ø¯Ø§ÙˆÙ„ "Ø¬Ù„Ø³Ø§Øª Ú©Ø§Ø±ÛŒ" Ùˆ "Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„ÛŒØª" Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯</li>
                </ul>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.dashboard-stat {
    background: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-number {
    font-size: 32px;
    font-weight: bold;
    color: #007cba;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 14px;
}

.form-horizontal .form-row {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

.form-horizontal .field-box {
    display: flex;
    flex-direction: column;
    min-width: 150px;
}

.form-horizontal .field-box label {
    margin-bottom: 5px;
    font-weight: bold;
}

.form-horizontal input, .form-horizontal select {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* Work Hours Badges */
.hours-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 12px;
}

.hours-badge.full-time {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.hours-badge.part-time {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.hours-badge.minimal {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Session Details */
.session-details-btn {
    background: #007cba;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
}

.session-details-btn:hover {
    background: #005a87;
}

.session-details {
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 12px;
}

.session-item {
    margin-bottom: 8px;
    padding: 6px;
    background: white;
    border-radius: 3px;
    border-left: 3px solid #007cba;
}

.no-sessions {
    color: #6c757d;
    font-style: italic;
    font-size: 12px;
}

/* Table Improvements */
#result_list th {
    background-color: #f8f9fa;
    font-weight: bold;
    text-align: center;
    padding: 12px 8px;
}

#result_list td {
    text-align: center;
    padding: 10px 8px;
    vertical-align: middle;
}

#result_list .work-hours {
    font-weight: bold;
}

/* Responsive Table */
@media (max-width: 1200px) {
    #result_list {
        font-size: 12px;
    }
    
    #result_list th, #result_list td {
        padding: 6px 4px;
    }
}
</style>

<script>
function toggleDetails(id) {
    const detailsDiv = document.getElementById('details_' + id);
    const button = event.target;
    
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        button.textContent = 'Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¬Ø²Ø¦ÛŒØ§Øª';
        button.style.backgroundColor = '#dc3545';
    } else {
        detailsDiv.style.display = 'none';
        button.textContent = 'Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª';
        button.style.backgroundColor = '#007cba';
    }
}

// Add summary row functionality
document.addEventListener('DOMContentLoaded', function() {
    // Calculate totals for each user
    const userTotals = {};
    const rows = document.querySelectorAll('#result_list tbody tr');
    
    rows.forEach(row => {
        const cells = row.cells;
        const user = cells[0].textContent.trim();
        const hours = parseFloat(cells[2].textContent.replace(' Ø³Ø§Ø¹Øª', '')) || 0;
        const activities = parseInt(cells[3].textContent) || 0;
        
        if (!userTotals[user]) {
            userTotals[user] = { hours: 0, activities: 0, days: 0 };
        }
        
        userTotals[user].hours += hours;
        userTotals[user].activities += activities;
        userTotals[user].days += 1;
    });
    
    // Add summary info to page
    if (Object.keys(userTotals).length > 0) {
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'module';
        summaryDiv.style.marginTop = '20px';
        summaryDiv.innerHTML = '<h2>ğŸ“Š Ø®Ù„Ø§ØµÙ‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h2>';
        
        const summaryTable = document.createElement('table');
        summaryTable.className = 'summary-table';
        summaryTable.innerHTML = `
            <thead>
                <tr>
                    <th>Ú©Ø§Ø±Ø¨Ø±</th>
                    <th>Ú©Ù„ Ø³Ø§Ø¹Ø§Øª</th>
                    <th>Ú©Ù„ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§</th>
                    <th>ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ²Ù‡Ø§</th>
                    <th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø±ÙˆØ²Ø§Ù†Ù‡</th>
                </tr>
            </thead>
            <tbody></tbody>
        `;
        
        const tbody = summaryTable.querySelector('tbody');
        
        Object.entries(userTotals).forEach(([user, totals]) => {
            const avgHours = (totals.hours / totals.days).toFixed(2);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${user}</strong></td>
                <td>${totals.hours.toFixed(2)} Ø³Ø§Ø¹Øª</td>
                <td>${totals.activities}</td>
                <td>${totals.days} Ø±ÙˆØ²</td>
                <td>${avgHours} Ø³Ø§Ø¹Øª/Ø±ÙˆØ²</td>
            `;
            tbody.appendChild(row);
        });
        
        summaryDiv.appendChild(summaryTable);
        document.querySelector('.module:last-of-type').after(summaryDiv);
    }
});
</script>

{% endblock %}
